<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Адмін-панель</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f9fafb;
            color: #1a202c;
            min-height: 100vh;
        }

        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .topbar .logo {
            font-size: 24px;
            font-weight: 700;
            color: #3182ce;
        }

        .topbar .search-bar {
            flex-grow: 1;
            max-width: 400px;
            margin-left: 20px;
        }

        .topbar .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            background-color: #f9fafb;
        }

        .topbar .search-bar input:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.1);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background-color: #ffffff;
            padding: 20px;
            border-right: 1px solid #e2e8f0;
            position: fixed;
            top: 60px;
            bottom: 0;
            overflow-y: auto;
        }

        .sidebar button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background: none;
            border: none;
            text-align: left;
            font-size: 16px;
            color: #1a202c;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .sidebar button:hover {
            background-color: #f1f5f9;
        }

        .sidebar button.active {
            background-color: #e2e8f0;
            font-weight: 500;
        }

        .content {
            margin-left: 240px;
            padding: 80px 20px 20px;
            width: calc(100% - 240px);
        }

        .admin-panel {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-panel h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #1a202c;
            font-weight: 600;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .controls .search-bar {
            flex-grow: 1;
            max-width: 300px;
        }

        .controls .search-bar input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
        }

        .controls select, .controls input[type="date"] {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
        }

        .controls button {
            padding: 10px 16px;
            background-color: #3182ce;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .controls button:hover {
            background-color: #2b6cb0;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #4a5568;
            flex-wrap: wrap;
        }

        .stats .stat-item {
            background-color: #f1f5f9;
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 120px;
            text-align: center;
        }

        .stats .stat-item strong {
            display: block;
            font-size: 20px;
            color: #1a202c;
        }

        .articles-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .articles-table th, .articles-table td {
            padding: 12px;
            border: 1px solid #e2e8f0;
            text-align: left;
            font-size: 15px;
        }

        .articles-table th {
            background-color: #f1f5f9;
            font-weight: 500;
        }

        .articles-table tr:hover {
            background-color: #f9fafb;
        }

        .articles-table .status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .articles-table .status.pending {
            background-color: #fef5e7;
            color: #d97706;
        }

        .articles-table .status.approved {
            background-color: #d4edda;
            color: #155724;
        }

        .articles-table .status.rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .articles-table button {
            padding: 6px 10px;
            margin: 0 3px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .articles-table .view {
            background-color: #3182ce;
            color: #fff;
        }

        .articles-table .view:hover {
            background-color: #2b6cb0;
        }

        .articles-table .approve {
            background-color: #38a169;
            color: #fff;
        }

        .articles-table .approve:hover {
            background-color: #2f855a;
        }

        .articles-table .reject {
            background-color: #e53e3e;
            color: #fff;
        }

        .articles-table .reject:hover {
            background-color: #c53030;
        }

        .articles-table .delete {
            background-color: #718096;
            color: #fff;
        }

        .articles-table .delete:hover {
            background-color: #5a6268;
        }

        .articles-table .edit {
            background-color: #805ad5;
            color: #fff;
        }

        .articles-table .edit:hover {
            background-color: #6b46c1;
        }

        .error {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .success {
            color: #38a169;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 8px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background-color: #fff;
            color: #1a202c;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #f1f5f9;
        }

        .pagination button.active {
            background-color: #3182ce;
            color: #fff;
            border-color: #3182ce;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .article-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .article-preview-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .article-preview-content h2 {
            font-size: 24px;
            color: #2b6cb0;
            margin-bottom: 15px;
        }

        .article-preview-content p {
            font-size: 16px;
            color: #4a5568;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .article-preview-content .author {
            font-size: 14px;
            color: #718096;
            font-style: italic;
            margin-top: 10px;
        }

        .article-preview-content .date {
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }

        .close-button {
            background-color: #e53e3e;
            margin-top: 15px;
            padding: 10px 20px;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .close-button:hover {
            background-color: #c53030;
        }

        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            z-index: 1000;
        }

        .mobile-nav .nav-buttons {
            display: flex;
            justify-content: space-around;
        }

        .mobile-nav button {
            background: none;
            border: none;
            font-size: 16px;
            color: #3182ce;
            cursor: pointer;
        }

        .mobile-nav button.active {
            color: #2b6cb0;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: #718096;
            font-size: 16px;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            .sidebar {
                display: none;
            }

            .topbar {
                padding: 0 15px;
                flex-direction: column;
                height: auto;
                align-items: flex-start;
            }

            .topbar .logo {
                font-size: 20px;
                margin-bottom: 10px;
            }

            .topbar .search-bar {
                width: 100%;
                margin-left: 0;
                margin-bottom: 10px;
            }

            .content {
                margin-left: 0;
                width: 100%;
                padding: 70px 15px 70px;
            }

            .admin-panel {
                padding: 15px;
                border-radius: 10px;
                box-shadow: none;
            }

            .admin-panel h1 {
                font-size: 24px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls .search-bar {
                max-width: none;
            }

            .stats {
                flex-direction: column;
            }

            .stats .stat-item {
                min-width: auto;
            }

            .articles-table th, .articles-table td {
                padding: 8px;
                font-size: 13px;
            }

            .articles-table button {
                padding: 5px 8px;
                font-size: 12px;
                margin: 2px;
            }

            .error, .success {
                font-size: 13px;
            }

            .mobile-nav {
                display: block;
            }

            .article-preview-content {
                width: 95%;
                padding: 15px;
            }

            .pagination button {
                padding: 6px 10px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="logo">Газета</div>
        <div class="search-bar">
            <input type="text" id="globalSearch" placeholder="Пошук по заголовку або автору...">
        </div>
    </div>
    <div class="container">
        <div class="sidebar">
            <button onclick="window.location.href='index.html'">Головна</button>
            <button onclick="window.location.href='word.html'">+</button>
            <button onclick="window.location.href='account.html'">Акаунт</button>
            <button class="active" onclick="window.location.href='admin.html'">Адмін-панель</button>
            <button id="logoutBtn" onclick="logout()">Вийти</button>
        </div>
        <div class="content">
            <div class="admin-panel">
                <h1>Адмін-панель</h1>
                <div id="loading" class="loading">Завантаження даних...</div>
                <div class="stats" id="stats"></div>
                <div class="controls">
                    <div class="search-bar">
                        <input type="text" id="tableSearch" placeholder="Пошук у таблиці...">
                    </div>
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="all">Усі статуси</option>
                        <option value="pending">Очікує</option>
                        <option value="approved">Схвалено</option>
                        <option value="rejected">Відхилено</option>
                    </select>
                    <input type="date" id="dateFrom" onchange="applyFilters()">
                    <input type="date" id="dateTo" onchange="applyFilters()">
                    <button onclick="exportToCSV()">Експорт у CSV</button>
                    <button onclick="refreshData()">Оновити</button>
                </div>
                <table class="articles-table">
                    <thead>
                        <tr>
                            <th>Заголовок</th>
                            <th>Автор</th>
                            <th>Дата</th>
                            <th>Статус</th>
                            <th>Дії</th>
                        </tr>
                    </thead>
                    <tbody id="articlesTableBody"></tbody>
                </table>
                <div class="pagination" id="pagination"></div>
                <div id="error" class="error"></div>
                <div id="success" class="success"></div>
            </div>
        </div>
    </div>
    <div id="articlePreview" class="article-preview">
        <div class="article-preview-content">
            <h2 id="previewTitle"></h2>
            <p id="previewContent"></p>
            <p id="previewAuthor" class="author"></p>
            <p id="previewDate" class="date"></p>
            <button class="close-button" onclick="closePreview()">Закрити</button>
        </div>
    </div>
    <div class="mobile-nav">
        <div class="nav-buttons">
            <button class="nav-button" onclick="window.location.href='index.html'">Головна</button>
            <button class="nav-button" onclick="window.location.href='word.html'">+</button>
            <button class="nav-button" onclick="window.location.href='account.html'">Акаунт</button>
            <button class="nav-button active" onclick="window.location.href='admin.html'">Адмін</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get, remove, push, child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCaifYiHxWGilT9umEgkVF6xjHMEJ4KDy8",
            authDomain: "newpaper-6cb18.firebaseapp.com",
            databaseURL: "https://newpaper-6cb18-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "newpaper-6cb18",
            storageBucket: "newpaper-6cb18.firebasestorage.app",
            messagingSenderId: "284037128087",
            appId: "1:284037128087:web:9f4f227bbdaab2eeadaed2",
            measurementId: "G-0EMERY88FL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let allArticles = [];
        let filteredArticles = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== 'petro.hryhorenko@gmail.com') {
                window.location.href = 'index.html';
            }
        });

        // Завантаження всіх статей (pending + approved + rejected)
        const loadAllArticles = () => {
            document.getElementById('loading').style.display = 'block';
            const pendingRef = ref(db, 'pending_articles');
            const approvedRef = ref(db, 'articles');

            Promise.all([
                get(pendingRef),
                get(approvedRef)
            ]).then(([pendingSnap, approvedSnap]) => {
                allArticles = [];
                const pending = pendingSnap.val() || {};
                const approved = approvedSnap.val() || {};

                Object.entries(pending).forEach(([id, article]) => {
                    allArticles.push({ id, ...article, source: 'pending' });
                });

                Object.entries(approved).forEach(([id, article]) => {
                    if (article.status === 'approved' || article.status === 'rejected') {
                        allArticles.push({ id, ...article, source: 'approved' });
                    }
                });

                allArticles.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                applyFilters();
                updateStats();
                document.getElementById('loading').style.display = 'none';
            }).catch(error => {
                showError('Помилка завантаження: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            });
        };

        // Оновлення статистики
        function updateStats() {
            const stats = {
                total: allArticles.length,
                pending: allArticles.filter(a => a.status === 'pending').length,
                approved: allArticles.filter(a => a.status === 'approved').length,
                rejected: allArticles.filter(a => a.status === 'rejected').length
            };
            document.getElementById('stats').innerHTML = `
                <div class="stat-item"><strong>${stats.total}</strong> Всього</div>
                <div class="stat-item"><strong>${stats.pending}</strong> Очікує</div>
                <div class="stat-item"><strong>${stats.approved}</strong> Схвалено</div>
                <div class="stat-item"><strong>${stats.rejected}</strong> Відхилено</div>
            `;
        }

        // Фільтрація та пагінація
        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('tableSearch').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredArticles = allArticles.filter(article => {
                const matchesStatus = status === 'all' || article.status === status;
                const matchesSearch = !search || 
                    article.title.toLowerCase().includes(search) || 
                    article.author.toLowerCase().includes(search);
                const timestamp = article.timestamp || 0;
                const articleDate = new Date(timestamp).toISOString().split('T')[0];
                const matchesDateFrom = !dateFrom || articleDate >= dateFrom;
                const matchesDateTo = !dateTo || articleDate <= dateTo;

                return matchesStatus && matchesSearch && matchesDateFrom && matchesDateTo;
            });

            currentPage = 1;
            renderTable();
            renderPagination();
        }

        // Рендер таблиці
        function renderTable() {
            const tableBody = document.getElementById('articlesTableBody');
            tableBody.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageArticles = filteredArticles.slice(start, end);

            if (pageArticles.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">Немає статей за вибраними фільтрами</td></tr>';
                return;
            }

            pageArticles.forEach(article => {
                const row = document.createElement('tr');
                const date = article.timestamp ? new Date(article.timestamp).toLocaleDateString('uk-UA') : '—';
                const statusClass = article.status || 'pending';
                const statusText = {
                    pending: 'Очікує',
                    approved: 'Схвалено',
                    rejected: 'Відхилено'
                }[statusClass] || 'Очікує';

                row.innerHTML = `
                    <td>${escapeHtml(article.title)}</td>
                    <td>${escapeHtml(article.author)}</td>
                    <td>${date}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="view" onclick="viewArticle('${article.id}', '${article.source}')">Переглянути</button>
                        ${article.status === 'pending' ? `<button class="approve" onclick="approveArticle('${article.id}')">Схвалити</button>` : ''}
                        ${article.status === 'pending' ? `<button class="reject" onclick="rejectArticle('${article.id}')">Відхилити</button>` : ''}
                        <button class="edit" onclick="editArticle('${article.id}', '${article.source}')">Редагувати</button>
                        <button class="delete" onclick="deleteArticle('${article.id}', '${article.source}')">Видалити</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Пагінація
        function renderPagination() {
            const totalPages = Math.ceil(filteredArticles.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‹';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderTable(); renderPagination(); };
            pagination.appendChild(prevBtn);

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.classList.toggle('active', i === currentPage);
                    pageBtn.onclick = () => { currentPage = i; renderTable(); renderPagination(); };
                    pagination.appendChild(pageBtn);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0 8px';
                    pagination.appendChild(dots);
                }
            }

            const nextBtn = document.createElement('button');
            nextBtn.textContent = '›';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderTable(); renderPagination(); };
            pagination.appendChild(nextBtn);
        }

        // Глобальний пошук
        document.getElementById('globalSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allArticles.filter(a => 
                a.title.toLowerCase().includes(query) || 
                a.author.toLowerCase().includes(query)
            );
            filteredArticles = filtered;
            currentPage = 1;
            renderTable();
            renderPagination();
        });

        // Пошук у таблиці
        document.getElementById('tableSearch').addEventListener('input', applyFilters);

        // Функції дій
        window.viewArticle = async (articleId, source) => {
            try {
                const path = source === 'pending' ? `pending_articles/${articleId}` : `articles/${articleId}`;
                const articleRef = ref(db, path);
                const snapshot = await get(articleRef);
                const article = snapshot.val();
                if (!article) throw new Error('Стаття не знайдена');

                document.getElementById('previewTitle').textContent = article.title;
                document.getElementById('previewContent').textContent = article.content;
                document.getElementById('previewAuthor').textContent = `Автор: ${article.author}`;
                document.getElementById('previewDate').textContent = `Дата: ${new Date(article.timestamp || 0).toLocaleString('uk-UA')}`;
                document.getElementById('articlePreview').style.display = 'flex';
            } catch (error) {
                showError('Помилка перегляду: ' + error.message);
            }
        };

        window.approveArticle = async (articleId) => {
            if (!confirm('Схвалити статтю?')) return;
            try {
                const pendingRef = ref(db, `pending_articles/${articleId}`);
                const snapshot = await get(pendingRef);
                const article = snapshot.val();
                if (!article) throw new Error('Стаття не знайдена');

                await set(ref(db, `articles/${articleId}`), {
                    ...article,
                    status: 'approved',
                    timestamp: Date.now()
                });
                await remove(pendingRef);
                showSuccess('Статтю схвалено!');
                loadAllArticles();
            } catch (error) {
                showError('Помилка схвалення: ' + error.message);
            }
        };

        window.rejectArticle = async (articleId) => {
            if (!confirm('Відхилити статтю?')) return;
            try {
                await set(ref(db, `pending_articles/${articleId}/status`), 'rejected');
                showSuccess('Статтю відхилено!');
                loadAllArticles();
            } catch (error) {
                showError('Помилка відхилення: ' + error.message);
            }
        };

        window.editArticle = (articleId, source) => {
            const newTitle = prompt('Новий заголовок:', '');
            if (newTitle === null) return;
            const newContent = prompt('Новий вміст:', '');
            if (newContent === null) return;

            const path = source === 'pending' ? `pending_articles/${articleId}` : `articles/${articleId}`;
            set(ref(db, `${path}/title`), newTitle);
            set(ref(db, `${path}/content`), newContent);
            showSuccess('Статтю відредаговано!');
            loadAllArticles();
        };

        window.deleteArticle = async (articleId, source) => {
            if (!confirm('Видалити статтю назавжди?')) return;
            try {
                const path = source === 'pending' ? `pending_articles/${articleId}` : `articles/${articleId}`;
                await remove(ref(db, path));
                showSuccess('Статтю видалено!');
                loadAllArticles();
            } catch (error) {
                showError('Помилка видалення: ' + error.message);
            }
        };

        window.closePreview = () => {
            document.getElementById('articlePreview').style.display = 'none';
        };

        window.exportToCSV = () => {
            const headers = ['ID', 'Заголовок', 'Автор', 'Статус', 'Дата'];
            const rows = filteredArticles.map(a => [
                a.id,
                `"${a.title.replace(/"/g, '""')}"`,
                a.author,
                a.status || 'pending',
                a.timestamp ? new Date(a.timestamp).toLocaleString('uk-UA') : ''
            ]);
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `articles_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };

        window.refreshData = () => {
            showSuccess('Дані оновлюються...');
            loadAllArticles();
        };

        // Допоміжні функції
        function showError(msg) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = msg;
            setTimeout(() => errorDiv.textContent = '', 5000);
        }

        function showSuccess(msg) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = msg;
            setTimeout(() => successDiv.textContent = '', 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.logout = async () => {
            try {
                await signOut(auth);
                alert('Вихід успішний!');
                window.location.href = 'index.html';
            } catch (error) {
                showError('Помилка виходу: ' + error.message);
            }
        };

        // Ініціалізація
        loadAllArticles();
    </script>
</body>
</html>