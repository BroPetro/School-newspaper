<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox-подібна платформа: Хрестики-Нулики + Морський Бій</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            color: #fff;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1s;
        }
        #loading h1 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ffcc;
        }
        .loader-bar {
            width: 300px;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }
        .loader-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00ffcc, #00bfff);
            animation: load 3s forwards;
        }
        @keyframes load {
            to { width: 100%; }
        }
        #app {
            display: none;
            height: 100vh;
        }
        #lobby {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        #lobby h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 15px #00ffcc;
        }
        .game-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin: 15px;
            width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 16px 48px rgba(0, 255, 255, 0.4);
        }
        .game-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        .game-card h3 {
            font-size: 24px;
            margin: 10px 0;
        }
        .game-card p {
            font-size: 14px;
            opacity: 0.8;
        }
        #game-container {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        #backBtn {
            padding: 10px 20px;
            background: #e74c3c;
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        #roomInfo {
            font-size: 18px;
            color: #00ffcc;
        }
        #game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        canvas {
            border: 3px solid #fff;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        #tictactoe-board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 10px;
            background: #333;
            padding: 10px;
            border-radius: 15px;
        }
        .ttt-cell {
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .ttt-cell:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        .ttt-cell.x { color: #e74c3c; }
        .ttt-cell.o { color: #3498db; }
        #battleship-my, #battleship-enemy {
            background: #001f3f;
        }
        #status {
            text-align: center;
            font-size: 22px;
            margin: 15px 0;
            font-weight: bold;
            text-shadow: 0 0 5px #00ffcc;
        }
        .action-btn {
            padding: 12px 24px;
            background: #00ffcc;
            color: #000;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        .action-btn:hover {
            background: #00bfff;
            transform: translateY(-3px);
        }
        .action-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #quickMatchBtn, #createRoomBtn, #joinRoomBtn {
            margin: 10px;
        }
        input {
            padding: 12px;
            border-radius: 10px;
            border: none;
            margin: 10px;
            text-align: center;
            font-size: 16px;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #00ffcc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Завантаження -->
    <div id="loading">
        <h1>Завантаження Roblox-подібної платформи...</h1>
        <div class="loader-bar"><div class="loader-fill"></div></div>
    </div>

    <!-- Основний додаток -->
    <div id="app">
        <!-- Лоббі -->
        <div id="lobby">
            <h1>Виберіть гру</h1>
            <div class="game-card" data-game="tictactoe">
                <img src="https://via.placeholder.com/300x150/3498db/ffffff?text=Хрестики-Нулики" alt="Tic-Tac-Toe">
                <h3>Хрестики-Нулики</h3>
                <p>Класична гра 3x3. Швидкі матчі онлайн!</p>
            </div>
            <div class="game-card" data-game="battleship">
                <img src="https://via.placeholder.com/300x150/e74c3c/ffffff?text=Морський+Бій" alt="Battleship">
                <h3>Морський Бій</h3>
                <p>Розмістіть флот і потопіть ворога!</p>
            </div>
        </div>

        <!-- Контейнер гри -->
        <div id="game-container">
            <div id="header">
                <button id="backBtn">Назад до лоббі</button>
                <div id="roomInfo"></div>
            </div>
            <div id="game-area"></div>
            <div id="controls" style="text-align: center;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, remove, onDisconnect, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCaifYiHxWGilT9umEgkVF6xjHMEJ4KDy8",
            authDomain: "newpaper-6cb18.firebaseapp.com",
            databaseURL: "https://newpaper-6cb18-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "newpaper-6cb18",
            storageBucket: "newpaper-6cb18.firebasestorage.app",
            messagingSenderId: "284037128087",
            appId: "1:284037128087:web:9f4f227bbdaab2eeadaed2",
            measurementId: "G-0EMERY88FL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // === Елементи ===
        const loading = document.getElementById('loading');
        const appDiv = document.getElementById('app');
        const lobby = document.getElementById('lobby');
        const gameContainer = document.getElementById('game-container');
        const gameArea = document.getElementById('game-area');
        const controls = document.getElementById('controls');
        const backBtn = document.getElementById('backBtn');
        const roomInfo = document.getElementById('roomInfo');

        // === Змінні ===
        let currentGame = null;
        let roomId = null;
        let player = null;
        let roomRef = null;
        let queueRef = null;

        // === Імітація завантаження ===
        setTimeout(() => {
            loading.style.opacity = '0';
            setTimeout(() => {
                loading.style.display = 'none';
                appDiv.style.display = 'block';
            }, 1000);
        }, 3000);

        // === Вибір гри ===
        document.querySelectorAll('.game-card').forEach(card => {
            card.addEventListener('click', () => {
                currentGame = card.dataset.game;
                lobby.style.display = 'none';
                gameContainer.style.display = 'flex';
                initGame(currentGame);
            });
        });

        backBtn.addEventListener('click', () => {
            cleanupRoom();
            gameContainer.style.display = 'none';
            lobby.style.display = 'flex';
            gameArea.innerHTML = '';
            controls.innerHTML = '';
            currentGame = null;
            roomId = null;
            player = null;
        });

        // === Ініціалізація гри ===
        function initGame(gameType) {
            gameArea.innerHTML = '';
            controls.innerHTML = `
                <button id="quickMatchBtn" class="action-btn">Швидка гра</button>
                <button id="createRoomBtn" class="action-btn">Створити кімнату</button>
                <button id="joinRoomBtn" class="action-btn">Приєднатися за кодом</button>
                <input type="text" id="roomCodeInput" placeholder="Код кімнати" style="display:none;">
                <div id="status"></div>
            `;

            const quickBtn = document.getElementById('quickMatchBtn');
            const createBtn = document.getElementById('createRoomBtn');
            const joinBtn = document.getElementById('joinRoomBtn');
            const input = document.getElementById('roomCodeInput');
            const statusEl = document.getElementById('status');

            quickBtn.onclick = () => startQuickMatch(gameType, statusEl);
            createBtn.onclick = () => createPrivateRoom(gameType, statusEl);
            joinBtn.onclick = () => { input.style.display = 'block'; input.focus(); };
            input.addEventListener('keypress', e => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    joinRoomByCode(gameType, e.target.value.trim().toUpperCase(), statusEl);
                }
            });

            if (gameType === 'tictactoe') {
                initTicTacToe();
            } else if (gameType === 'battleship') {
                initBattleship(statusEl);
            }
        }

        // === Хрестики-Нулики ===
        function initTicTacToe() {
            const board = document.createElement('div');
            board.id = 'tictactoe-board';
            gameArea.appendChild(board);
        }

        function startTicTacToeGame() {
            const boardEl = document.getElementById('tictactoe-board');
            const cells = boardEl.querySelectorAll('.ttt-cell') || [];
            if (cells.length === 0) {
                for (let i = 0; i < 9; i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('ttt-cell');
                    cell.dataset.index = i;
                    cell.addEventListener('click', () => makeTicTacToeMove(i));
                    boardEl.appendChild(cell);
                }
            }
            updateTicTacToeBoard();
        }

        function makeTicTacToeMove(index) {
            if (!roomRef || player !== getCurrentGameData().currentTurn) return;
            const data = getCurrentGameData();
            if (data.board[index]) return;
            data.board[index] = player;
            const winner = checkTicTacToeWinner(data.board);
            data.gameActive = !winner;
            data.winner = winner;
            data.currentTurn = player === 'X' ? 'O' : 'X';
            set(roomRef, data);
        }

        function checkTicTacToeWinner(board) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let [a,b,c] of wins) {
                if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
            }
            if (board.every(c => c)) return 'draw';
            return null;
        }

        function updateTicTacToeBoard() {
            if (!roomRef) return;
            onValue(roomRef, snap => {
                const data = snap.val();
                if (!data) return;
                const cells = document.querySelectorAll('.ttt-cell');
                data.board.forEach((mark, i) => {
                    cells[i].textContent = mark;
                    cells[i].className = 'ttt-cell';
                    if (mark === 'X') cells[i].classList.add('x');
                    if (mark === 'O') cells[i].classList.add('o');
                });
                const statusEl = document.getElementById('status');
                if (!data.gameActive) {
                    const result = data.winner;
                    if (result === 'draw') statusEl.textContent = 'Нічия!';
                    else if (result === player) statusEl.textContent = 'Ви перемогли!';
                    else statusEl.textContent = 'Ви програли.';
                    addRestartButton();
                } else {
                    statusEl.textContent = data.currentTurn === player ? 'Ваш хід!' : 'Хід суперника...';
                }
            });
        }

        // === Морський Бій ===
        function initBattleship(statusEl) {
            const myCanvas = document.createElement('canvas');
            myCanvas.id = 'battleship-my';
            myCanvas.width = 300;
            myCanvas.height = 300;
            const enemyCanvas = document.createElement('canvas');
            enemyCanvas.id = 'battleship-enemy';
            enemyCanvas.width = 300;
            enemyCanvas.height = 300;
            gameArea.appendChild(myCanvas);
            gameArea.appendChild(enemyCanvas);

            statusEl.textContent = 'Розмістіть кораблі (клік по своєму полю).';
            // Додати логіку розміщення...
        }

        // === Кімнати та черга ===
        function generateCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        async function startQuickMatch(gameType, statusEl) {
            statusEl.innerHTML = '<div class="loader"></div> Пошук суперника...';
            queueRef = ref(db, `queue/${gameType}`);
            const entry = push(queueRef);
            set(entry, { ts: serverTimestamp() });
            onValue(queueRef, async snap => {
                const entries = snap.val();
                if (entries && Object.keys(entries).length >= 2) {
                    const ids = Object.keys(entries);
                    if (ids[0] === entry.key) {
                        await createPrivateRoom(gameType, statusEl);
                        ids.slice(0, 2).forEach(id => remove(ref(db, `queue/${gameType}/${id}`)));
                    }
                }
            });
            onDisconnect(entry).remove();
        }

        async function createPrivateRoom(gameType, statusEl) {
            roomId = generateCode();
            roomRef = ref(db, `rooms/${gameType}/${roomId}`);
            const initialData = gameType === 'tictactoe' ? {
                board: Array(9).fill(''),
                currentTurn: 'X',
                gameActive: true,
                playerX: null,
                playerO: null
            } : {
                p1Board: null,
                p2Board: null,
                p1Ready: false,
                p2Ready: false,
                currentTurn: 'P1',
                shotsP1: Array(10).fill().map(() => Array(10).fill(0)),
                shotsP2: Array(10).fill().map(() => Array(10).fill(0))
            };
            await set(roomRef, initialData);
            roomInfo.textContent = `Код: ${roomId}`;
            player = 'X'; // або P1
            listenToGame(gameType, statusEl);
        }

        function joinRoomByCode(gameType, code, statusEl) {
            roomId = code;
            roomRef = ref(db, `rooms/${gameType}/${roomId}`);
            onValue(roomRef, snap => {
                if (!snap.exists()) {
                    statusEl.textContent = 'Кімната не знайдена.';
                    return;
                }
                roomInfo.textContent = `Кімната: ${roomId}`;
                player = gameType === 'tictactoe' ? 'O' : 'P2';
                listenToGame(gameType, statusEl);
            }, { onlyOnce: true });
        }

        function listenToGame(gameType, statusEl) {
            onValue(roomRef, snap => {
                const data = snap.val();
                if (!data) return;
                if (gameType === 'tictactoe') {
                    if (!player && !data.playerX) { player = 'X'; set(roomRef, { ...data, playerX: true }); }
                    else if (!player && !data.playerO) { player = 'O'; set(roomRef, { ...data, playerO: true }); }
                    startTicTacToeGame();
                    updateTicTacToeBoard();
                }
                // Додати для battleship...
            });
        }

        function getCurrentGameData() {
            // Повертає поточний стан
            return {};
        }

        function addRestartButton() {
            if (document.getElementById('restartBtn')) return;
            const btn = document.createElement('button');
            btn.id = 'restartBtn';
            btn.className = 'action-btn';
            btn.textContent = 'Нова гра';
            btn.onclick = () => {
                const initial = currentGame === 'tictactoe' ? {
                    board: Array(9).fill(''),
                    currentTurn: 'X',
                    gameActive: true,
                    winner: null
                } : {};
                set(roomRef, initial);
            };
            controls.appendChild(btn);
        }

        function cleanupRoom() {
            if (roomRef) onDisconnect(roomRef).remove();
            if (queueRef) remove(queueRef);
        }
    </script>
</body>
</html>