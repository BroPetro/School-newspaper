<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –≥–∞–∑–µ—Ç–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  margin: 0;
  font-family: 'Roboto', 'Inter', sans-serif;
  background: #e8ecef;
  transition: background 0.3s, color 0.3s;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

body.dark {
  background: #121212;
  color: #e0e0e0;
}

.sidebar {
  width: 250px;
  background: #1a1a2e;
  color: #fff;
  padding: 20px 0;
  position: fixed;
  height: 100%;
  box-shadow: 2px 0 5px rgba(0,0,0,0.3);
  transition: transform 0.3s ease-in-out;
  z-index: 1000;
}

.sidebar.dark {
  background: #0a0a0a;
}

.sidebar ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.sidebar ul li {
  padding: 15px 20px;
  cursor: pointer;
  transition: background 0.2s;
}

.sidebar ul li:hover {
  background: #2e2e4e;
}

.sidebar ul li.active {
  background: #1976d2;
}

.main-content {
  margin-left: 250px;
  padding: 20px;
  width: calc(100% - 250px);
  box-sizing: border-box;
  flex-grow: 1;
}

header {
  background: #1a1a2e;
  color: #fff;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  margin-bottom: 20px;
}

header.dark {
  background: #0a0a0a;
}

header h1 {
  font-size: clamp(20px, 5vw, 24px);
  margin: 0;
  font-weight: 700;
}

.header-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
}

.button {
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s, transform 0.1s;
  position: relative;
  font-size: clamp(14px, 3vw, 16px);
}

.button:hover {
  background: #115293;
  transform: translateY(-2px);
}

.button.secondary {
  background: #ff9800;
}

.button.secondary:hover {
  background: #e68a00;
}

.button.favorite {
  background: #4caf50;
}

.button.favorite:hover {
  background: #388e3c;
}

.button.logout {
  background: #ff4d4d;
}

.button.logout:hover {
  background: #d32f2f;
}

.button::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
  display: none;
}

.button:hover::after {
  display: block;
}

.auth-box, .form-box, .admin-box, .profile-box {
  background: #fff;
  padding: 20px;
  margin: 20px 0;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  transition: transform 0.2s;
}

.auth-box.dark, .form-box.dark, .admin-box.dark, .profile-box.dark {
  background: #1e1e2f;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
}

.auth-box:hover, .form-box:hover, .admin-box:hover, .profile-box:hover {
  transform: translateY(-5px);
}

.profile-box {
  max-width: 800px;
  margin: 20px auto;
}

.profile-box h3 {
  text-align: center;
  font-size: clamp(20px, 5vw, 24px);
  margin-bottom: 20px;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 20px;
  padding: 15px;
  background: #f5f5f5;
  border-radius: 8px;
}

.profile-header.dark {
  background: #2b2b3a;
}

.profile-header .avatar {
  width: 60px;
  height: 60px;
  background: #ccc;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #fff;
}

.profile-header .avatar.dark {
  background: #444;
}

.profile-sections {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.profile-section {
  padding: 15px;
  border-radius: 8px;
  background: #f9f9f9;
}

.profile-section.dark {
  background: #2b2b3a;
}

.profile-section h4 {
  margin: 0 0 10px 0;
  font-size: clamp(16px, 4vw, 18px);
  color: #333;
}

.profile-section.dark h4 {
  color: #bbb;
}

.auth-box h3, .form-box h3 {
  margin-top: 0;
  text-align: center;
  font-size: clamp(18px, 5vw, 22px);
}

.auth-toggle {
  text-align: center;
  margin-top: 15px;
  color: #1976d2;
  cursor: pointer;
  font-weight: 500;
  font-size: clamp(14px, 3vw, 16px);
}

.auth-toggle:hover {
  text-decoration: underline;
}

.article-card {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.article-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.article-card.dark {
  background: #1e1e2f;
}

.article-card h3 {
  margin: 0 0 8px 0;
  font-size: clamp(18px, 4vw, 20px);
}

.article-card small {
  color: #666;
  display: block;
  margin-bottom: 10px;
  font-size: clamp(12px, 3vw, 14px);
}

.article-card.dark small {
  color: #aaa;
}

.reactions button {
  margin: 8px 8px 0 0;
  background: #e3f2fd;
  color: #1976d2;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
  font-size: clamp(12px, 3vw, 14px);
}

.reactions button:hover {
  background: #bbdefb;
}

.reactions button.dark {
  background: #2b2b3a;
  color: #90caf9;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  overflow-y: auto;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 90%;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-sizing: border-box;
}

.modal-content.dark {
  background: #1e1e2f;
  color: #e0e0e0;
}

.close {
  position: absolute;
  top: 10px;
  right: 15px;
  cursor: pointer;
  font-size: 20px;
  color: #ff4d4d;
}

img.article-img {
  max-width: 100%;
  max-height: 400px;
  object-fit: contain;
  border-radius: 12px;
  margin: 15px 0;
  display: block;
}

input, textarea, select {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: clamp(14px, 3.5vw, 16px);
  box-sizing: border-box;
}

input.dark, textarea.dark, select.dark {
  background: #2b2b3a;
  border-color: #444;
  color: #e0e0e0;
}

textarea {
  resize: vertical;
  min-height: 100px;
}

.tags-input {
  margin: 10px 0;
  padding: 10px;
}

.theme-toggle {
  background: #ff9800;
}

.theme-toggle:hover {
  background: #e68a00;
}

.search-box {
  margin: 15px 0;
}

.search-box input {
  padding: 10px;
  font-size: clamp(14px, 3.5vw, 16px);
  border-radius: 8px;
  width: 100%;
  box-sizing: border-box;
}

.comments-section {
  margin-top: 20px;
}

.comment {
  border-top: 1px solid #eee;
  padding: 10px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.comment.dark {
  border-top-color: #444;
}

.comment small {
  color: #666;
  font-size: clamp(12px, 3vw, 14px);
}

.comment.dark small {
  color: #aaa;
}

.comment .delete-comment {
  background: #ff4d4d;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 5px 10px;
  cursor: pointer;
  font-size: clamp(12px, 3vw, 14px);
}

.comment .delete-comment:hover {
  background: #d32f2f;
}

.error-message {
  color: #ff4d4d;
  font-size: clamp(12px, 3vw, 14px);
  margin: 5px 0;
  display: none;
}

.input-error {
  border-color: #ff4d4d;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
  font-size: clamp(14px, 3.5vw, 16px);
}

.preview-box {
  margin: 10px 0;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #f9f9f9;
}

.preview-box.dark {
  background: #2b2b3a;
  border-color: #444;
}

.format-buttons {
  display: flex;
  gap: 8px;
  margin: 10px 0;
  flex-wrap: wrap;
}

.format-buttons button {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  font-size: clamp(12px, 3vw, 14px);
}

.format-buttons button:hover {
  background: #e0e0e0;
}

.format-buttons button.dark {
  background: #1e1e2f;
  border-color: #444;
  color: #e0e0e0;
}

.format-buttons button.dark:hover {
  background: #2b2b3a;
}

.alert-box {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #4caf50;
  color: #fff;
  padding: 10px 15px;
  border-radius: 8px;
  z-index: 1001;
  display: none;
  font-size: clamp(12px, 3vw, 14px);
}

.alert-box.error {
  background: #ff4d4d;
}

.alert-box button {
  background: none;
  border: none;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  margin-left: 10px;
}

.section {
  margin-bottom: 15px;
}

.section h4 {
  margin: 0 0 8px 0;
  font-size: clamp(16px, 4vw, 18px);
  color: #333;
}

.section.dark h4 {
  color: #bbb;
}

.recommendation-banner {
  background: #e3f2fd;
  padding: 10px;
  margin-bottom: 20px;
  border-radius: 8px;
  text-align: center;
  font-size: clamp(14px, 3.5vw, 16px);
}

.recommendation-banner.dark {
  background: #2b2b3a;
  color: #90caf9;
}

/* Mobile-specific styles */
@media (max-width: 768px) {
  body {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    height: auto;
    position: relative;
    transform: translateX(-100%);
    transition: transform 0.3s ease-in-out;
  }

  .sidebar.active {
    transform: translateX(0);
  }

  .main-content {
    margin-left: 0;
    width: 100%;
    padding: 15px;
  }

  header {
    flex-direction: column;
    align-items: flex-start;
    padding: 10px 15px;
  }

  .header-buttons {
    width: 100%;
    margin-top: 10px;
    flex-direction: column;
    gap: 8px;
  }

  .search-box input, .category-filter select {
    width: 100%;
  }

  .button {
    width: 100%;
    text-align: center;
    padding: 10px;
  }

  .modal-content {
    max-width: 95%;
    padding: 15px;
  }

  .article-card {
    padding: 15px;
    margin-bottom: 15px;
  }

  img.article-img {
    max-height: 250px;
  }

  .auth-box, .form-box, .admin-box, .profile-box {
    padding: 15px;
    margin: 15px 0;
  }

  .profile-sections {
    grid-template-columns: 1fr;
  }

  .format-buttons {
    flex-direction: column;
  }

  .format-buttons button {
    width: 100%;
    text-align: center;
  }

  .sidebar-toggle {
    display: block;
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 1001;
    background: #1976d2;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 18px;
  }
}

@media (min-width: 769px) {
  .sidebar-toggle {
    display: none;
  }
}
</style>
</head>
<body>
<div class="sidebar">
<ul>
  <li id="homeBtn" class="active">üè† –ì–æ–ª–æ–≤–Ω–∞</li>
  <li id="createBtn">‚úçÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é</li>
  <li id="adminBtn" style="display:none;">üõ°Ô∏è –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</li>
  <li id="accountBtn">üë§ –ê–∫–∞—É–Ω—Ç</li>
  <li id="communityBtn">üë• –ù–∞—à–∞ —Å–ø—ñ–ª—å–Ω–æ—Ç–∞</li>
  <li id="themeBtn">üåì –¢–µ–º–Ω–∞ —Ç–µ–º–∞</li>
</ul>
</div>
<div class="main-content">
<header>
  <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
  <h1>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –≥–∞–∑–µ—Ç–∞</h1>
  <div class="header-buttons">
    <select id="categoryFilter" class="category-filter dark">
      <option value="">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
      <option value="–ù–æ–≤–∏–Ω–∏">–ù–æ–≤–∏–Ω–∏</option>
      <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
      <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó">–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó</option>
      <option value="–ö—É–ª—å—Ç—É—Ä–∞">–ö—É–ª—å—Ç—É—Ä–∞</option>
    </select>
    <input type="text" id="searchInput" class="search-box" placeholder="–ü–æ—à—É–∫ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∞–±–æ —Ç–µ–≥–æ–º" data-tooltip="–ü–æ—à—É–∫ —Å—Ç–∞—Ç–µ–π">
  </div>
</header>

<div class="alert-box" id="alertBox"><span id="alertMessage"></span><button onclick="this.parentElement.style.display='none'">‚úñ</button></div>

<div class="recommendation-banner" id="recommendationBanner" style="display:none;"></div>

<div class="auth-box" id="authBox" style="display:none;">
<div id="registerForm">
<h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
<div class="section"><h4>–î–∞–Ω—ñ</h4>
<input type="text" id="registerNickname" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º">
<div class="error-message" id="registerNicknameError"></div>
<input type="email" id="registerEmail" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞">
<div class="error-message" id="registerEmailError"></div>
<input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤)">
<div class="error-message" id="registerPasswordError"></div></div>
<button class="button" onclick="register()" data-tooltip="–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
<div class="auth-toggle" onclick="toggleAuthForm()">–í–∂–µ –º–∞—î—Ç–µ –∞–∫–∞—É–Ω—Ç? –£–≤—ñ–π—Ç–∏</div>
</div>
<div id="loginForm" style="display:none;">
<h3>–í—Ö—ñ–¥</h3>
<div class="section"><h4>–î–∞–Ω—ñ</h4>
<input type="email" id="loginEmail" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞">
<div class="error-message" id="loginEmailError"></div>
<input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
<div class="error-message" id="loginPasswordError"></div></div>
<button class="button" onclick="login()" data-tooltip="–£–≤—ñ–π—Ç–∏">–£–≤—ñ–π—Ç–∏</button>
<div class="auth-toggle" onclick="toggleAuthForm()">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</div>
</div>
</div>

<div class="profile-box" id="profileBox" style="display:none;">
<h3>–í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å</h3>
<div class="profile-header">
  <div class="avatar dark">üë§</div>
  <div>
    <h4 id="profileName"></h4>
    <button class="button logout" onclick="logout()" data-tooltip="–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç–∞">–í–∏–π—Ç–∏</button>
  </div>
</div>
<div class="profile-sections">
<div class="profile-section dark">
<h4>–ù—ñ–∫–Ω–µ–π–º</h4>
<input type="text" id="profileNickname" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º">
<button class="button" onclick="updateNickname()" data-tooltip="–û–Ω–æ–≤–∏—Ç–∏ –Ω—ñ–∫–Ω–µ–π–º">–û–Ω–æ–≤–∏—Ç–∏</button>
</div>
<div class="profile-section dark">
<h4>–í–∞—à—ñ —Å—Ç–∞—Ç—Ç—ñ</h4>
<div id="userArticles"></div>
</div>
<div class="profile-section dark">
<h4>–í–∞—à—ñ —á–µ—Ä–Ω–µ—Ç–∫–∏</h4>
<div id="userDrafts"></div>
</div>
<div class="profile-section dark">
<h4>–û–±—Ä–∞–Ω—ñ —Å—Ç–∞—Ç—Ç—ñ</h4>
<div id="userFavorites"></div>
</div>
</div>
</div>

<div class="form-box" id="articleForm" style="display:none;">
<h3>–°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é</h3>
<div class="section"><h4>–ó–∞–≥–æ–ª–æ–≤–æ–∫</h4><input type="text" id="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"></div>
<div class="section"><h4>–¢–µ–∫—Å—Ç</h4><textarea id="content" rows="6" placeholder="–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ"></textarea>
</div>
<div class="section"><h4>–¢–µ–≥–∏</h4><input type="text" id="tags" placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∫–æ–º—É" class="tags-input"></div>
<div class="section"><h4>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</h4>
<select id="category" class="dark">
  <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
  <option value="–ù–æ–≤–∏–Ω–∏">–ù–æ–≤–∏–Ω–∏</option>
  <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
  <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó">–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó</option>
  <option value="–ö—É–ª—å—Ç—É—Ä–∞">–ö—É–ª—å—Ç—É—Ä–∞</option>
</select></div>
<div class="section"><h4>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</h4>
<label class="checkbox-label">
  <input type="checkbox" id="includeImage" onclick="toggleImageInput()"> –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
</label>
<input type="text" id="image" placeholder="URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è" style="display:none;"></div>
<button class="button" onclick="previewArticle()" data-tooltip="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Å—Ç–∞—Ç—Ç—é">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
<button class="button secondary" onclick="saveDraft()" data-tooltip="–ó–±–µ—Ä–µ–≥—Ç–∏ —á–µ—Ä–Ω–µ—Ç–∫—É">–ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —á–µ—Ä–Ω–µ—Ç–∫—É</button>
<button class="button" onclick="addArticle()" data-tooltip="–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—Ç—é">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
<div id="previewBox" class="preview-box" style="display:none;"></div>
</div>

<div id="adminPanel" class="admin-box" style="display:none;">
<h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å: –û—á—ñ–∫—É—é—Ç—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
<div id="pendingArticles"></div>
</div>

<div id="articles"></div>
</div>

<div class="modal" id="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">‚úñ</span>
<div id="modalBody"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, increment, getDoc, arrayUnion, arrayRemove, deleteDoc, setDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCS_jrZxtztQeArogU8yfCm4BIiNphapsE",
  authDomain: "party-8c521.firebaseapp.com",
  projectId: "party-8c521",
  storageBucket: "party-8c521.firebasestorage.app",
  messagingSenderId: "630338352175",
  appId: "1:630338352175:web:96367f9e3223677b58c2da",
  measurementId: "G-L76NX1ZBWX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const accountBtn = document.getElementById("accountBtn");
const createBtn = document.getElementById("createBtn");
const adminBtn = document.getElementById("adminBtn");
const homeBtn = document.getElementById("homeBtn");
const themeBtn = document.getElementById("themeBtn");
const articleForm = document.getElementById("articleForm");
const adminPanel = document.getElementById("adminPanel");
const articlesDiv = document.getElementById("articles");
const authBox = document.getElementById("authBox");
const profileBox = document.getElementById("profileBox");
const pendingDiv = document.getElementById("pendingArticles");
const searchInput = document.getElementById("searchInput");
const categoryFilter = document.getElementById("categoryFilter");
const registerForm = document.getElementById("registerForm");
const loginForm = document.getElementById("loginForm");
const previewBox = document.getElementById("previewBox");
const alertBox = document.getElementById("alertBox");
const alertMessage = document.getElementById("alertMessage");
const recommendationBanner = document.getElementById("recommendationBanner");

function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('active');
}

async function setThemePreference(user, theme) {
  if (!user) return;
  const prefRef = doc(db, "preferences", user.uid);
  try {
    await setDoc(prefRef, { theme }, { merge: true });
  } catch (error) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–µ–º–∏:", error);
  }
}

async function getThemePreference(user) {
  if (!user) return "light";
  const prefRef = doc(db, "preferences", user.uid);
  try {
    const prefSnap = await getDoc(prefRef);
    return prefSnap.exists() && prefSnap.data().theme ? prefSnap.data().theme : "light";
  } catch (error) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–µ–º–∏:", error);
    return "light";
  }
}

themeBtn.onclick = async () => {
  document.body.classList.toggle("dark");
  document.querySelectorAll('.modal-content, .article-card, .auth-box, .form-box, .admin-box, .profile-box, .profile-header, .profile-section, .preview-box, .sidebar, .recommendation-banner').forEach(e => e.classList.toggle('dark'));
  document.querySelectorAll('input, textarea, select, .format-buttons button, .button').forEach(e => e.classList.toggle('dark'));
  document.querySelectorAll('.avatar').forEach(e => e.classList.toggle('dark'));
  const theme = document.body.classList.contains("dark") ? "dark" : "light";
  if (auth.currentUser) {
    await setThemePreference(auth.currentUser, theme);
  }
};

function showAlert(message, isError = false) {
  alertMessage.textContent = message;
  alertBox.className = `alert-box ${isError ? 'error' : ''}`;
  alertBox.style.display = 'block';
  setTimeout(() => alertBox.style.display = 'none', 5000);
}

function showError(elementId, message) {
  const errorElement = document.getElementById(elementId);
  errorElement.textContent = message;
  errorElement.style.display = "block";
  document.getElementById(elementId.replace("Error", "")).classList.add("input-error");
}

function clearErrors(formType) {
  const errors = document.querySelectorAll(`#${formType}Form .error-message`);
  const inputs = document.querySelectorAll(`#${formType}Form input`);
  errors.forEach(e => { e.style.display = "none"; e.textContent = ""; });
  inputs.forEach(i => i.classList.remove("input-error"));
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

async function updateUserPreferences(user, category) {
  if (!user) return;
  const prefRef = doc(db, "preferences", user.uid);
  try {
    const prefSnap = await getDoc(prefRef);
    let interests = prefSnap.exists() ? prefSnap.data().interests || [] : [];
    if (category === "–°–ø–æ—Ä—Ç" && !interests.includes("–°–ø–æ—Ä—Ç")) {
      interests.push("–°–ø–æ—Ä—Ç");
      await setDoc(prefRef, { uid: user.uid, interests }, { merge: true });
      showAlert("–í–∞—à—ñ —ñ–Ω—Ç–µ—Ä–µ—Å–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ: –¥–æ–¥–∞–Ω–æ –°–ø–æ—Ä—Ç");
    }
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤: " + error.message, true);
  }
}

async function getUserPreferences(user) {
  if (!user) return [];
  const prefRef = doc(db, "preferences", user.uid);
  try {
    const prefSnap = await getDoc(prefRef);
    return prefSnap.exists() ? prefSnap.data().interests || [] : [];
  } catch (error) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤:", error);
    return [];
  }
}

async function register() {
  clearErrors("register");
  const nickname = document.getElementById("registerNickname").value.trim();
  const email = document.getElementById("registerEmail").value.trim();
  const password = document.getElementById("registerPassword").value;
  
  if (!nickname) { showError("registerNicknameError", "–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º"); return; }
  if (!validateEmail(email)) { showError("registerEmailError", "–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –ø–æ—à—Ç—É"); return; }
  if (password.length < 6) { showError("registerPasswordError", "–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ ‚â• 6 —Å–∏–º–≤–æ–ª—ñ–≤"); return; }
  
  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await updateProfile(userCred.user, { displayName: nickname });
    await setDoc(doc(db, "preferences", userCred.user.uid), { uid: userCred.user.uid, interests: [], theme: "light" });
    showAlert("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!");
    authBox.style.display = "none";
  } catch (error) {
    if (error.code === "auth/email-already-in-use") {
      showError("registerEmailError", "–¶—è –ø–æ—à—Ç–∞ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∞");
    } else {
      showError("registerEmailError", "–ü–æ–º–∏–ª–∫–∞: " + error.message);
    }
  }
}

async function login() {
  clearErrors("login");
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;
  
  if (!validateEmail(email)) { showError("loginEmailError", "–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –ø–æ—à—Ç—É"); return; }
  if (!password) { showError("loginPasswordError", "–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å"); return; }
  
  try {
    await signInWithEmailAndPassword(auth, email, password);
    showAlert("–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π!");
    authBox.style.display = "none";
  } catch (error) {
    if (error.code === "auth/wrong-password" || error.code === "auth/user-not-found") {
      showError("loginEmailError", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –ø–æ—à—Ç–∞ –∞–±–æ –ø–∞—Ä–æ–ª—å");
    } else {
      showError("loginEmailError", "–ü–æ–º–∏–ª–∫–∞: " + error.message);
    }
  }
}

function toggleAuthForm() {
  registerForm.style.display = registerForm.style.display === "none" ? "block" : "none";
  loginForm.style.display = loginForm.style.display === "none" ? "block" : "none";
  clearErrors("register");
  clearErrors("login");
}

async function logout() {
  try {
    await signOut(auth);
    showAlert("–í–∏ –≤–∏–π—à–ª–∏ –∑ –∞–∫–∞—É–Ω—Ç–∞");
    articleForm.style.display = "none";
    adminPanel.style.display = "none";
    profileBox.style.display = "none";
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: " + error.message, true);
  }
}

async function updateNickname() {
  const nickname = document.getElementById("profileNickname").value.trim();
  const user = auth.currentUser;
  if (!nickname) {
    showAlert("–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º", true);
    return;
  }
  try {
    await updateProfile(user, { displayName: nickname });
    document.getElementById("profileName").textContent = nickname;
    showAlert("–ù—ñ–∫–Ω–µ–π–º –æ–Ω–æ–≤–ª–µ–Ω–æ");
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω—ñ–∫–Ω–µ–π–º—É: " + error.message, true);
  }
}

async function loadUserProfile(user) {
  if (!user) return;
  document.getElementById("profileNickname").value = user.displayName || "";
  document.getElementById("profileName").textContent = user.displayName || "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á";
  const articlesQuery = query(collection(db, "articles"), where("uid", "==", user.uid));
  const draftsQuery = query(collection(db, "drafts"), where("uid", "==", user.uid));
  const favoritesQuery = query(collection(db, "favorites"), where("uid", "==", user.uid));

  const userArticles = document.getElementById("userArticles");
  const userDrafts = document.getElementById("userDrafts");
  const userFavorites = document.getElementById("userFavorites");

  userArticles.innerHTML = "";
  userDrafts.innerHTML = "";
  userFavorites.innerHTML = "";

  try {
    const articlesSnap = await getDocs(articlesQuery);
    articlesSnap.forEach(doc => {
      const article = doc.data();
      const div = document.createElement("div");
      div.classList.add("article-card");
      let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
      div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | –°—Ç–∞—Ç—É—Å: ${article.status}</small>${imgHTML}<p>${article.content.substring(0, 100)}...</p>`;
      div.onclick = () => openModal(doc.id, article);
      userArticles.appendChild(div);
    });

    const draftsSnap = await getDocs(draftsQuery);
    draftsSnap.forEach(doc => {
      const draft = doc.data();
      const div = document.createElement("div");
      div.classList.add("article-card");
      let imgHTML = draft.image ? `<img class="article-img" src="${draft.image}">` : "";
      div.innerHTML = `<h3>${draft.title}</h3><small>${draft.date}</small>${imgHTML}<p>${draft.content.substring(0, 100)}...</p>`;
      userDrafts.appendChild(div);
    });

    const favoritesSnap = await getDocs(favoritesQuery);
    for (const favDoc of favoritesSnap.docs) {
      const fav = favDoc.data();
      const articleDoc = await getDoc(doc(db, "articles", fav.articleId));
      if (articleDoc.exists()) {
        const article = articleDoc.data();
        const div = document.createElement("div");
        div.classList.add("article-card");
        let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
        div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.author}</small>${imgHTML}<p>${article.content.substring(0, 100)}...</p>`;
        div.onclick = () => openModal(fav.articleId, article);
        userFavorites.appendChild(div);
      }
    }
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é: " + error.message, true);
  }
}

function toggleImageInput() {
  const imageInput = document.getElementById("image");
  imageInput.style.display = document.getElementById("includeImage").checked ? "block" : "none";
}

function formatText(style) {
  const content = document.getElementById("content");
  const start = content.selectionStart;
  const end = content.selectionEnd;
  const selectedText = content.value.substring(start, end);
  
  if (selectedText) {
    let formattedText;
    switch (style) {
      case 'bold': formattedText = `**${selectedText}**`; break;
      case 'italic': formattedText = `_${selectedText}_`; break;
      case 'underline': formattedText = `<u>${selectedText}</u>`; break;
    }
    content.value = content.value.substring(0, start) + formattedText + content.value.substring(end);
  }
}

function previewArticle() {
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  const image = document.getElementById("includeImage").checked ? document.getElementById("image").value.trim() : "";
  const tags = document.getElementById("tags").value.trim().split(",").map(t => t.trim()).filter(t => t);
  const category = document.getElementById("category").value;

  if (title || content) {
    let imgHTML = image ? `<img class="article-img" src="${image}">` : "";
    previewBox.innerHTML = `
      <h2>${title || "–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥"}</h2>
      <p>${content || "–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É..."}</p>
      ${imgHTML}
      <div>–¢–µ–≥–∏: ${(tags.length ? tags.join(", ") : "–ñ–æ–¥–Ω–∏—Ö —Ç–µ–≥—ñ–≤")}</div>
      <div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>
    `;
    previewBox.style.display = "block";
  } else {
    showAlert("–í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–±–æ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É", true);
  }
}

async function saveDraft() {
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  const image = document.getElementById("includeImage").checked ? document.getElementById("image").value.trim() : "";
  const tags = document.getElementById("tags").value.trim().split(",").map(t => t.trim()).filter(t => t);
  const category = document.getElementById("category").value;
  const user = auth.currentUser;

  if (user) {
    try {
      await addDoc(collection(db, "drafts"), {
        title, content, image, tags, category,
        author: user.displayName || user.email,
        uid: user.uid,
        date: new Date().toLocaleString(),
        status: "draft"
      });
      showAlert("–ß–µ—Ä–Ω–µ—Ç–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞!");
      document.getElementById("title").value = "";
      document.getElementById("content").value = "";
      document.getElementById("image").value = "";
      document.getElementById("tags").value = "";
      document.getElementById("includeImage").checked = false;
      toggleImageInput();
      document.getElementById("category").value = "";
      previewBox.style.display = "none";
    } catch (error) {
      showAlert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–µ—Ä–Ω–µ—Ç–∫–∏: " + error.message, true);
    }
  } else {
    showAlert("–£–≤—ñ–π–¥—ñ—Ç—å –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–µ—Ä–Ω–µ—Ç–∫–∏", true);
  }
}

async function addArticle() {
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  const image = document.getElementById("includeImage").checked ? document.getElementById("image").value.trim() : "";
  const tags = document.getElementById("tags").value.trim().split(",").map(t => t.trim()).filter(t => t);
  const category = document.getElementById("category").value;
  const user = auth.currentUser;
  if (title && content && user) {
    try {
      await addDoc(collection(db, "articles"), {
        title, content, image, tags, category,
        author: user.displayName || user.email,
        uid: user.uid,
        date: new Date().toLocaleString(),
        likes: 0, dislikes: 0, hearts: 0,
        likedBy: [], dislikedBy: [], heartedBy: [],
        comments: [],
        status: "pending"
      });
      if (category === "–°–ø–æ—Ä—Ç") {
        await updateUserPreferences(user, category);
      }
      showAlert("–°—Ç–∞—Ç—Ç—è –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞");
      document.getElementById("title").value = "";
      document.getElementById("content").value = "";
      document.getElementById("image").value = "";
      document.getElementById("tags").value = "";
      document.getElementById("includeImage").checked = false;
      toggleImageInput();
      document.getElementById("category").value = "";
      previewBox.style.display = "none";
    } catch (error) {
      showAlert("–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ: " + error.message, true);
    }
  } else {
    showAlert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ", true);
  }
}

async function editArticle(id) {
  const articleRef = doc(db, "articles", id);
  try {
    const docSnap = await getDoc(articleRef);
    const article = docSnap.data();
    if (article.uid !== auth.currentUser.uid && auth.currentUser.email !== "petro.hryhorenko@gmail.com") return;
    
    document.getElementById("modalBody").innerHTML = `
      <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—Ç—é</h2>
      <div class="section"><h4>–ó–∞–≥–æ–ª–æ–≤–æ–∫</h4><input type="text" id="editTitle" value="${article.title}"></div>
      <div class="section"><h4>–¢–µ–∫—Å—Ç</h4><textarea id="editContent" rows="6">${article.content}</textarea>
      <div class="format-buttons">
        <button onclick="formatEditText('bold')" data-tooltip="–ñ–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç">–ñ–∏—Ä–Ω–∏–π</button>
        <button onclick="formatEditText('italic')" data-tooltip="–ö—É—Ä—Å–∏–≤">–ö—É—Ä—Å–∏–≤</button>
        <button onclick="formatEditText('underline')" data-tooltip="–ü—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–∏–π">–ü—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–∏–π</button>
      </div></div>
      <div class="section"><h4>–¢–µ–≥–∏</h4><input type="text" id="editTags" value="${article.tags.join(', ')}" class="tags-input"></div>
      <div class="section"><h4>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</h4>
      <select id="editCategory" class="dark">
        <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
        <option value="–ù–æ–≤–∏–Ω–∏" ${article.category === "–ù–æ–≤–∏–Ω–∏" ? "selected" : ""}>–ù–æ–≤–∏–Ω–∏</option>
        <option value="–°–ø–æ—Ä—Ç" ${article.category === "–°–ø–æ—Ä—Ç" ? "selected" : ""}>–°–ø–æ—Ä—Ç</option>
        <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó" ${article.category === "–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó" ? "selected" : ""}>–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó</option>
        <option value="–ö—É–ª—å—Ç—É—Ä–∞" ${article.category === "–ö—É–ª—å—Ç—É—Ä–∞" ? "selected" : ""}>–ö—É–ª—å—Ç—É—Ä–∞</option>
      </select></div>
      <div class="section"><h4>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</h4>
      <label class="checkbox-label">
        <input type="checkbox" id="editIncludeImage" ${article.image ? 'checked' : ''} onclick="toggleEditImageInput()"> –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      </label>
      <input type="text" id="editImage" value="${article.image}" style="display:${article.image ? 'block' : 'none'};"></div>
      <button class="button" onclick="saveEditedArticle('${id}')" data-tooltip="–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    `;
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ: " + error.message, true);
  }
}

function toggleEditImageInput() {
  const imageInput = document.getElementById("editImage");
  imageInput.style.display = document.getElementById("editIncludeImage").checked ? "block" : "none";
}

function formatEditText(style) {
  const content = document.getElementById("editContent");
  const start = content.selectionStart;
  const end = content.selectionEnd;
  const selectedText = content.value.substring(start, end);
  
  if (selectedText) {
    let formattedText;
    switch (style) {
      case 'bold': formattedText = `**${selectedText}**`; break;
      case 'italic': formattedText = `_${selectedText}_`; break;
      case 'underline': formattedText = `<u>${selectedText}</u>`; break;
    }
    content.value = content.value.substring(0, start) + formattedText + content.value.substring(end);
  }
}

async function saveEditedArticle(id) {
  const title = document.getElementById("editTitle").value.trim();
  const content = document.getElementById("editContent").value.trim();
  const image = document.getElementById("editIncludeImage").checked ? document.getElementById("editImage").value.trim() : "";
  const tags = document.getElementById("editTags").value.trim().split(",").map(t => t.trim()).filter(t => t);
  const category = document.getElementById("editCategory").value;
  if (title && content) {
    try {
      await updateDoc(doc(db, "articles", id), {
        title, content, image, tags, category,
        status: auth.currentUser.email === "petro.hryhorenko@gmail.com" ? "approved" : "pending"
      });
      if (category === "–°–ø–æ—Ä—Ç") {
        await updateUserPreferences(auth.currentUser, category);
      }
      closeModal();
      showAlert("–°—Ç–∞—Ç—Ç—é –æ–Ω–æ–≤–ª–µ–Ω–æ");
    } catch (error) {
      showAlert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ: " + error.message, true);
    }
  } else {
    showAlert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ", true);
  }
}

async function deleteArticle(id) {
  if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é?")) {
    try {
      await deleteDoc(doc(db, "articles", id));
      closeModal();
      showAlert("–°—Ç–∞—Ç—Ç—é –≤–∏–¥–∞–ª–µ–Ω–æ");
    } catch (error) {
      showAlert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: " + error.message, true);
    }
  }
}

async function addComment(id) {
  const commentInput = document.getElementById("commentInput");
  const commentText = commentInput.value.trim();
  const user = auth.currentUser;
  if (commentText && user) {
    try {
      const articleRef = doc(db, "articles", id);
      const docSnap = await getDoc(articleRef);
      const article = docSnap.data();
      await updateDoc(articleRef, {
        comments: arrayUnion({
          text: commentText,
          author: user.displayName || user.email,
          date: new Date().toLocaleString()
        })
      });
      if (article.category === "–°–ø–æ—Ä—Ç") {
        await updateUserPreferences(user, "–°–ø–æ—Ä—Ç");
      }
      commentInput.value = "";
      showAlert("–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ–¥–∞–Ω–æ");
    } catch (error) {
      showAlert("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è: " + error.message, true);
    }
  } else {
    showAlert("–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è", true);
  }
}

async function deleteComment(id, comment) {
  const user = auth.currentUser;
  if (!user || (comment.author !== (user.displayName || user.email) && user.email !== "petro.hryhorenko@gmail.com")) {
    showAlert("–í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–æ–º–µ–Ω—Ç–∞—Ä", true);
    return;
  }
  try {
    await updateDoc(doc(db, "articles", id), {
      comments: arrayRemove(comment)
    });
    showAlert("–ö–æ–º–µ–Ω—Ç–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ");
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è: " + error.message, true);
  }
}

async function toggleFavorite(id) {
  const user = auth.currentUser;
  if (!user) {
    showAlert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ", true);
    return;
  }
  try {
    const favQuery = query(collection(db, "favorites"), where("uid", "==", user.uid), where("articleId", "==", id));
    const favSnap = await getDocs(favQuery);
    if (favSnap.empty) {
      await addDoc(collection(db, "favorites"), {
        uid: user.uid,
        articleId: id,
        date: new Date().toLocaleString()
      });
      showAlert("–î–æ–¥–∞–Ω–æ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ");
      const articleDoc = await getDoc(doc(db, "articles", id));
      if (articleDoc.exists() && articleDoc.data().category === "–°–ø–æ—Ä—Ç") {
        await updateUserPreferences(user, "–°–ø–æ—Ä—Ç");
      }
    } else {
      favSnap.forEach(async doc => {
        await deleteDoc(doc.ref);
      });
      showAlert("–í–∏–¥–∞–ª–µ–Ω–æ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ");
    }
    openModal(id, (await getDoc(doc(db, "articles", id))).data());
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞: " + error.message, true);
  }
}

async function renderArticles(snapshot, searchTerm, userInterests, selectedCategory) {
  articlesDiv.innerHTML = "";
  pendingDiv.innerHTML = "";
  const user = auth.currentUser;
  
  let articles = [];
  snapshot.forEach(docSnap => {
    articles.push({ id: docSnap.id, data: docSnap.data() });
  });

  if (userInterests.includes("–°–ø–æ—Ä—Ç") && !selectedCategory) {
    articles.sort((a, b) => {
      if (a.data.category === "–°–ø–æ—Ä—Ç" && b.data.category !== "–°–ø–æ—Ä—Ç") return -1;
      if (a.data.category !== "–°–ø–æ—Ä—Ç" && b.data.category === "–°–ø–æ—Ä—Ç") return 1;
      return new Date(b.data.date) - new Date(a.data.date);
    });
    recommendationBanner.textContent = "–†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –¥–ª—è –≤–∞—Å: –°–ø–æ—Ä—Ç";
    recommendationBanner.style.display = "block";
  } else {
    recommendationBanner.style.display = "none";
    articles.sort((a, b) => new Date(b.data.date) - new Date(a.data.date));
  }

  articles.forEach(({ id, data: article }) => {
    const matchesSearch = !searchTerm || 
      article.title.toLowerCase().includes(searchTerm) || 
      article.tags.some(tag => tag.toLowerCase().includes(searchTerm));
    const matchesCategory = !selectedCategory || article.category === selectedCategory;
    
    if (article.status === "approved" && matchesSearch && matchesCategory) {
      const div = document.createElement("div");
      div.classList.add("article-card");
      let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
      div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.author}</small>${imgHTML}<p>${article.content.substring(0, 100)}...</p><div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${article.category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>`;
      div.onclick = () => openModal(id, article);
      articlesDiv.appendChild(div);
    } else if (user?.email === "petro.hryhorenko@gmail.com" && matchesSearch && matchesCategory) {
      const div = document.createElement("div");
      div.classList.add("article-card");
      let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
      div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.author} | –°—Ç–∞—Ç—É—Å: –û—á—ñ–∫—É—î</small>${imgHTML}<p>${article.content.substring(0, 100)}...</p><div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${article.category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>`;
      const approveBtn = document.createElement("button");
      approveBtn.textContent = "‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏";
      approveBtn.className = "button";
      approveBtn.onclick = async (e) => {
        e.stopPropagation();
        try {
          await updateDoc(doc(db, "articles", id), { status: "approved" });
          showAlert("–°—Ç–∞—Ç—Ç—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞");
        } catch (error) {
          showAlert("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: " + error.message, true);
        }
      };
      const rejectBtn = document.createElement("button");
      rejectBtn.textContent = "‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏";
      rejectBtn.className = "button secondary";
      rejectBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é?")) {
          try {
            await deleteDoc(doc(db, "articles", id));
            showAlert("–°—Ç–∞—Ç—Ç—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–∞");
          } catch (error) {
            showAlert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: " + error.message, true);
          }
        }
      };
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "üóë –í–∏–¥–∞–ª–∏—Ç–∏";
      deleteBtn.className = "button";
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é?")) {
          try {
            await deleteDoc(doc(db, "articles", id));
            showAlert("–°—Ç–∞—Ç—Ç—è –≤–∏–¥–∞–ª–µ–Ω–∞");
          } catch (error) {
            showAlert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: " + error.message, true);
          }
        }
      };
      div.appendChild(approveBtn);
      div.appendChild(rejectBtn);
      div.appendChild(deleteBtn);
      pendingDiv.appendChild(div);
    }
  });
}

let debounceTimeout;
function updateArticleList() {
  clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(async () => {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const selectedCategory = categoryFilter.value;
    const userInterests = await getUserPreferences(auth.currentUser);
    const q = query(collection(db, "articles"), orderBy("date", "desc"));
    onSnapshot(q, (snapshot) => {
      renderArticles(snapshot, searchTerm, userInterests, selectedCategory);
    });
  }, 300);
}

searchInput.oninput = updateArticleList;
categoryFilter.onchange = updateArticleList;

onAuthStateChanged(auth, async (user) => {
  if (user) {
    accountBtn.textContent = "üë§ –ê–∫–∞—É–Ω—Ç";
    accountBtn.onclick = () => {
      profileBox.style.display = profileBox.style.display === "block" ? "none" : "block";
      authBox.style.display = "none";
      articleForm.style.display = "none";
      adminPanel.style.display = "none";
      if (profileBox.style.display === "block") {
        loadUserProfile(user);
      }
    };
    articleForm.style.display = "none";
    adminBtn.style.display = user.email === "petro.hryhorenko@gmail.com" ? "block" : "none";
    adminPanel.style.display = "none";
    createBtn.onclick = () => {
      articleForm.style.display = articleForm.style.display === "block" ? "none" : "block";
      profileBox.style.display = "none";
      adminPanel.style.display = "none";
      if (articleForm.style.display === "block") {
        previewBox.style.display = "none";
      }
    };
    adminBtn.onclick = () => {
      adminPanel.style.display = adminPanel.style.display === "block" ? "none" : "block";
      articleForm.style.display = "none";
      profileBox.style.display = "none";
    };
    homeBtn.onclick = () => {
      articleForm.style.display = "none";
      adminPanel.style.display = "none";
      profileBox.style.display = "none";
    };
    const theme = await getThemePreference(user);
    if (theme === "dark") {
      document.body.classList.add("dark");
      document.querySelectorAll('.modal-content, .article-card, .auth-box, .form-box, .admin-box, .profile-box, .profile-header, .profile-section, .preview-box, .sidebar, .recommendation-banner').forEach(e => e.classList.add('dark'));
      document.querySelectorAll('input, textarea, select, .format-buttons button, .button').forEach(e => e.classList.add('dark'));
      document.querySelectorAll('.avatar').forEach(e => e.classList.add('dark'));
    }
  } else {
    accountBtn.textContent = "üë§ –ê–∫–∞—É–Ω—Ç";
    accountBtn.onclick = () => {
      authBox.style.display = authBox.style.display === "block" ? "none" : "block";
      registerForm.style.display = "block";
      loginForm.style.display = "none";
      clearErrors("register");
      clearErrors("login");
      articleForm.style.display = "none";
      adminPanel.style.display = "none";
      profileBox.style.display = "none";
    };
    articleForm.style.display = "none";
    adminPanel.style.display = "none";
    adminBtn.style.display = "none";
    authBox.style.display = "none";
    profileBox.style.display = "none";
  }
  homeBtn.onclick();
  const userInterests = await getUserPreferences(user);
  updateArticleList();
});

async function react(id, type) {
  const user = auth.currentUser;
  if (!user) { showAlert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ —Ä–µ–∞–∫—Ü—ñ—é", true); return; }
  const articleRef = doc(db, "articles", id);
  try {
    const docSnap = await getDoc(articleRef);
    const data = docSnap.data();
    if (data.category === "–°–ø–æ—Ä—Ç") {
      await updateUserPreferences(user, "–°–ø–æ—Ä—Ç");
    }
    const arrs = { likes: "likedBy", dislikes: "dislikedBy", hearts: "heartedBy" };
    const currentArr = arrs[type];
    for (let key in arrs) {
      if (key !== type && data[arrs[key]].includes(user.uid)) {
        await updateDoc(articleRef, { [key]: increment(-1), [arrs[key]]: arrayRemove(user.uid) });
      }
    }
    if (!data[currentArr].includes(user.uid)) {
      await updateDoc(articleRef, { [type]: increment(1), [currentArr]: arrayUnion(user.uid) });
    }
    showAlert("–†–µ–∞–∫—Ü—ñ—è –¥–æ–¥–∞–Ω–∞");
  } catch (error) {
    showAlert("–ü–æ–º–∏–ª–∫–∞ —Ä–µ–∞–∫—Ü—ñ—ó: " + error.message, true);
  }
}

async function openModal(id, article) {
  const user = auth.currentUser;
  if (article.category === "–°–ø–æ—Ä—Ç") {
    await updateUserPreferences(user, "–°–ø–æ—Ä—Ç");
  }
  document.getElementById("modal").style.display = "flex";
  let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
  let editButton = (user && (article.uid === user.uid || user.email === "petro.hryhorenko@gmail.com")) ? 
    `<button class="button" onclick="editArticle('${id}')" data-tooltip="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—Ç—é">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>` : "";
  let deleteButton = (user && (article.uid === user.uid || user.email === "petro.hryhorenko@gmail.com")) ? 
    `<button class="button" onclick="deleteArticle('${id}')" data-tooltip="–í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>` : "";
  let shareButton = `<button class="button" onclick="shareArticle('${id}')" data-tooltip="–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è —Å—Ç–∞—Ç—Ç–µ—é">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>`;
  let favoriteButton = user ? `<button class="button favorite" onclick="toggleFavorite('${id}')" data-tooltip="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ">‚≠ê –î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ</button>` : "";
  
  let commentsHTML = (article.comments || []).map(comment => `
    <div class="comment">
      <div>
        <p>${comment.text}</p>
        <small>${comment.date} | ${comment.author}</small>
      </div>
      ${(user && (comment.author === (user.displayName || user.email) || user.email === "petro.hryhorenko@gmail.com")) ? 
        `<button class="delete-comment" onclick='deleteComment("${id}", ${JSON.stringify(comment)})'>üóë</button>` : ""}
    </div>
  `).join('');
  
  document.getElementById("modalBody").innerHTML = `
    <h2>${article.title}</h2>
    <small>${article.date} | ${article.author}</small>
    ${imgHTML}
    <p>${article.content}</p>
    <div class="reactions">
      <button class="${document.body.classList.contains('dark') ? 'dark' : ''}" onclick="react('${id}','likes')">üëç ${article.likes || 0}</button>
      <button class="${document.body.classList.contains('dark') ? 'dark' : ''}" onclick="react('${id}','dislikes')">üëé ${article.dislikes || 0}</button>
      <button class="${document.body.classList.contains('dark') ? 'dark' : ''}" onclick="react('${id}','hearts')">‚ù§Ô∏è ${article.hearts || 0}</button>
    </div>
    <div>–¢–µ–≥–∏: ${(article.tags || []).join(", ")}</div>
    <div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${article.category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>
    ${editButton}
    ${deleteButton}
    ${shareButton}
    ${favoriteButton}
    <div class="comments-section">
      <h3>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h3>
      ${commentsHTML}
      ${user ? `
        <textarea id="commentInput" rows="3" placeholder="–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä" class="${document.body.classList.contains('dark') ? 'dark' : ''}"></textarea>
        <button class="button" onclick="addComment('${id}')" data-tooltip="–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä">–ö–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏</button>
      ` : ''}
    </div>
  `;
}

function shareArticle(id) {
  const url = `${window.location.origin}/article/${id}`;
  navigator.clipboard.writeText(url).then(() => {
    showAlert("–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–∞—Ç—Ç—é —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!");
  }).catch(() => {
    showAlert("–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è", true);
  });
}
document.getElementById("communityBtn").onclick = () => {
  window.open("https://t.me/newspaper36", "_blank");
};
function closeModal() { document.getElementById("modal").style.display = "none"; }

window.register = register;
window.login = login;
window.logout = logout;
window.addArticle = addArticle;
window.openModal = openModal;
window.closeModal = closeModal;
window.react = react;
window.editArticle = editArticle;
window.saveEditedArticle = saveEditedArticle;
window.deleteArticle = deleteArticle;
window.addComment = addComment;
window.deleteComment = deleteComment;
window.shareArticle = shareArticle;
window.toggleAuthForm = toggleAuthForm;
window.toggleImageInput = toggleImageInput;
window.toggleEditImageInput = toggleEditImageInput;
window.formatText = formatText;
window.formatEditText = formatEditText;
window.previewArticle = previewArticle;
window.saveDraft = saveDraft;
window.toggleSidebar = toggleSidebar;
window.updateNickname = updateNickname;
window.toggleFavorite = toggleFavorite;
</script>
</body>
</html>
