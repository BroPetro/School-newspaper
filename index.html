<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –≥–∞–∑–µ—Ç–∞ - —Å—É—á–∞—Å–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏–Ω">
  <title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –≥–∞–∑–µ—Ç–∞</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f4f9;
      color: #333;
      min-height: 100vh;
      display: flex;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #121212;
      color: #e0e0e0;
    }
    .container {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }
    .sidebar {
      width: 220px;
      background: #1a1a2e;
      color: #fff;
      padding: 20px;
      position: fixed;
      height: 100%;
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .sidebar.dark { background: #0a0a0a; }
    .sidebar ul {
      list-style: none;
      padding: 0;
    }
    .sidebar li {
      padding: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar li:hover { background: #2e2e4e; }
    .sidebar li.active { background: #1976d2; }
    .main-content {
      margin-left: 220px;
      padding: 20px;
      width: calc(100% - 220px);
      flex-grow: 1;
    }
    header {
      background: #1a1a2e;
      color: #fff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    header.dark { background: #0a0a0a; }
    header h1 {
      font-size: clamp(18px, 4vw, 22px);
      font-weight: 700;
    }
    .header-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .button {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: clamp(12px, 3vw, 14px);
      transition: background 0.2s;
    }
    .button:hover { background: #115293; }
    .button.secondary { background: #ff9800; }
    .button.secondary:hover { background: #e68a00; }
    .button.favorite { background: #4caf50; }
    .button.favorite:hover { background: #388e3c; }
    .button.logout { background: #ff4d4d; }
    .button.logout:hover { background: #d32f2f; }
    .install-button {
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: clamp(12px, 3vw, 14px);
      transition: background 0.2s;
      display: block;
      width: 100%;
      text-align: left;
    }
    .install-button:hover { background: #388e3c; }
    .auth-box, .form-box, .admin-box, .profile-box {
      background: #fff;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .auth-box.dark, .form-box.dark, .admin-box.dark, .profile-box.dark {
      background: #1e1e2f;
      color: #e0e0e0;
    }
    .profile-box {
      max-width: 700px;
      margin: 15px auto;
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
    }
    .profile-header.dark { background: #2b2b3a; }
    .profile-header .avatar {
      width: 50px;
      height: 50px;
      background: #ccc;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
    }
    .profile-header.dark .avatar { background: #444; }
    .profile-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .profile-section {
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    .profile-section.dark { background: #2b2b3a; }
    .profile-section h4 { margin: 0 0 8px; font-size: clamp(14px, 3vw, 16px); }
    .profile-section.dark h4 { color: #bbb; }
    .article-card {
      background: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .article-card:hover { transform: translateY(-3px); }
    .article-card.dark { background: #1e1e2f; }
    .article-card h3 { font-size: clamp(16px, 4vw, 18px); margin: 0 0 8px; }
    .article-card small { color: #666; font-size: clamp(12px, 3vw, 13px); }
    .article-card.dark small { color: #aaa; }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content.dark { background: #1e1e2f; color: #e0e0e0; }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
      color: #ff4d4d;
    }
    img.article-img {
      max-width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 8px;
      margin: 10px 0;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: clamp(13px, 3vw, 14px);
    }
    input.dark, textarea.dark, select.dark {
      background: #2b2b3a;
      border-color: #444;
      color: #e0e0e0;
    }
    textarea { resize: vertical; min-height: 80px; }
    .reactions button {
      background: #e3f2fd;
      color: #1976d2;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: clamp(12px, 3vw, 13px);
    }
    .reactions button:hover { background: #bbdefb; }
    .reactions button.dark { background: #2b2b3a; color: #90caf9; }
    .alert-box {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #4caf50;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      z-index: 1001;
      display: none;
      font-size: clamp(12px, 3vw, 13px);
    }
    .alert-box.error { background: #ff4d4d; }
    .alert-box button { background: none; border: none; color: #fff; cursor: pointer; }
    .search-box input, .category-filter select {
      padding: 8px;
      font-size: clamp(13px, 3vw, 14px);
    }
    .comments-section { margin-top: 15px; }
    .comment {
      border-top: 1px solid #eee;
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
    }
    .comment.dark { border-top-color: #444; }
    .comment small { color: #666; font-size: clamp(11px, 3vw, 12px); }
    .comment.dark small { color: #aaa; }
    .comment .delete-comment {
      background: #ff4d4d;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 5px 8px;
      cursor: pointer;
    }
    .error-message {
      color: #ff4d4d;
      font-size: clamp(11px, 3vw, 12px);
      margin: 5px 0;
      display: none;
    }
    .input-error { border-color: #ff4d4d; }
    .auth-toggle {
      text-align: center;
      margin-top: 10px;
      color: #1976d2;
      cursor: pointer;
      font-size: clamp(12px, 3vw, 14px);
    }
    .auth-toggle:hover { text-decoration: underline; }
    .offline-message {
      background: #ff4d4d;
      color: #fff;
      text-align: center;
      padding: 10px;
      display: none;
      font-size: clamp(12px, 3vw, 14px);
    }
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .sidebar {
        width: 100%;
        position: fixed;
        transform: translateX(-100%);
      }
      .sidebar.active { transform: translateX(0); }
      .main-content { margin-left: 0; width: 100%; padding: 15px; }
      header { flex-direction: column; align-items: flex-start; }
      .header-buttons { flex-direction: column; width: 100%; gap: 8px; }
      .button, .install-button { width: 100%; text-align: center; }
      .modal-content { max-width: 95%; padding: 15px; }
      .profile-sections { grid-template-columns: 1fr; }
      .sidebar-toggle {
        display: block;
        position: fixed;
        top: 10px;
        left: 10px;
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px;
        cursor: pointer;
        z-index: 1001;
      }
      img.article-img { max-height: 200px; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
    }
  </style>
</head>
<body>
  <div class="offline-message" id="offlineMessage">–í–∏ –æ—Ñ–ª–∞–π–Ω. –î–µ—è–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.</div>
  <div class="container">
    <div class="sidebar">
      <ul>
        <li id="homeBtn" class="active">üè† –ì–æ–ª–æ–≤–Ω–∞</li>
        <li id="createBtn">‚úçÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é</li>
        <li id="adminBtn" style="display:none;">üõ°Ô∏è –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</li>
        <li id="accountBtn">üë§ –£–≤—ñ–π—Ç–∏</li>
        <li id="themeBtn">üåì –¢–µ–º–Ω–∞ —Ç–µ–º–∞</li>
        <li><button id="installBtn" class="install-button">üì± –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫</button></li>
      </ul>
    </div>
    <div class="main-content">
      <header>
        <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
        <h1>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –≥–∞–∑–µ—Ç–∞</h1>
        <div class="header-buttons">
          <select id="categoryFilter" class="category-filter dark">
            <option value="">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
            <option value="–ù–æ–≤–∏–Ω–∏">–ù–æ–≤–∏–Ω–∏</option>
            <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
            <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó">–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó</option>
            <option value="–ö—É–ª—å—Ç—É—Ä–∞">–ö—É–ª—å—Ç—É—Ä–∞</option>
          </select>
          <input type="text" id="searchInput" class="search-box" placeholder="–ü–æ—à—É–∫ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º">
        </div>
      </header>
      <div class="alert-box" id="alertBox"><span id="alertMessage"></span><button onclick="this.parentElement.style.display='none'">‚úñ</button></div>
      <div class="auth-box" id="authBox" style="display:none;">
        <div id="registerForm">
          <h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
          <input type="text" id="registerNickname" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º">
          <div class="error-message" id="registerNicknameError"></div>
          <input type="email" id="registerEmail" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞">
          <div class="error-message" id="registerEmailError"></div>
          <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤)">
          <div class="error-message" id="registerPasswordError"></div>
          <button class="button" onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <div class="auth-toggle" onclick="toggleAuthForm()">–í–∂–µ –º–∞—î—Ç–µ –∞–∫–∞—É–Ω—Ç? –£–≤—ñ–π—Ç–∏</div>
        </div>
        <div id="loginForm" style="display:none;">
          <h3>–í—Ö—ñ–¥</h3>
          <input type="email" id="loginEmail" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞">
          <div class="error-message" id="loginEmailError"></div>
          <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
          <div class="error-message" id="loginPasswordError"></div>
          <button class="button" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
          <div class="auth-toggle" onclick="toggleAuthForm()">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</div>
        </div>
      </div>
      <div class="profile-box" id="profileBox" style="display:none;">
        <h3>–í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å</h3>
        <div class="profile-header">
          <div class="avatar dark">üë§</div>
          <div>
            <h4 id="profileName"></h4>
            <button class="button logout" onclick="logout()">–í–∏–π—Ç–∏</button>
          </div>
        </div>
        <div class="profile-sections">
          <div class="profile-section dark">
            <h4>–ù—ñ–∫–Ω–µ–π–º</h4>
            <input type="text" id="profileNickname" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º">
            <button class="button" onclick="updateNickname()">–û–Ω–æ–≤–∏—Ç–∏</button>
          </div>
          <div class="profile-section dark">
            <h4>–í–∞—à—ñ —Å—Ç–∞—Ç—Ç—ñ</h4>
            <div id="userArticles"></div>
          </div>
          <div class="profile-section dark">
            <h4>–û–±—Ä–∞–Ω—ñ —Å—Ç–∞—Ç—Ç—ñ</h4>
            <div id="userFavorites"></div>
          </div>
        </div>
      </div>
      <div class="form-box" id="articleForm" style="display:none;">
        <h3>–°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é</h3>
        <input type="text" id="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
        <textarea id="content" rows="5" placeholder="–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ"></textarea>
        <input type="text" id="tags" placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∫–æ–º—É">
        <select id="category" class="dark">
          <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
          <option value="–ù–æ–≤–∏–Ω–∏">–ù–æ–≤–∏–Ω–∏</option>
          <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
          <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó">–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó</option>
          <option value="–ö—É–ª—å—Ç—É—Ä–∞">–ö—É–ª—å—Ç—É—Ä–∞</option>
        </select>
        <label><input type="checkbox" id="includeImage" onclick="toggleImageInput()"> –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
        <input type="text" id="image" placeholder="URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è" style="display:none;">
        <button class="button" onclick="previewArticle()">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
        <button class="button" onclick="addArticle()">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        <div id="previewBox" class="preview-box" style="display:none;"></div>
      </div>
      <div id="adminPanel" class="admin-box" style="display:none;">
        <h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3>
        <div id="pendingArticles"></div>
      </div>
      <div id="articles"></div>
      <div class="modal" id="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal()">‚úñ</span>
          <div id="modalBody"></div>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, increment, getDoc, arrayUnion, arrayRemove, deleteDoc, setDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCS_jrZxtztQeArogU8yfCm4BIiNphapsE",
      authDomain: "party-8c521.firebaseapp.com",
      projectId: "party-8c521",
      storageBucket: "party-8c521.firebasestorage.app",
      messagingSenderId: "630338352175",
      appId: "1:630338352175:web:96367f9e3223677b58c2da",
      measurementId: "G-L76NX1ZBWX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const accountBtn = document.getElementById("accountBtn");
    const createBtn = document.getElementById("createBtn");
    const adminBtn = document.getElementById("adminBtn");
    const homeBtn = document.getElementById("homeBtn");
    const themeBtn = document.getElementById("themeBtn");
    const installBtn = document.getElementById("installBtn");
    const articleForm = document.getElementById("articleForm");
    const adminPanel = document.getElementById("adminPanel");
    const articlesDiv = document.getElementById("articles");
    const authBox = document.getElementById("authBox");
    const profileBox = document.getElementById("profileBox");
    const pendingDiv = document.getElementById("pendingArticles");
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");
    const registerForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const previewBox = document.getElementById("previewBox");
    const alertBox = document.getElementById("alertBox");
    const alertMessage = document.getElementById("alertMessage");
    const offlineMessage = document.getElementById("offlineMessage");

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    window.addEventListener('appinstalled', () => {
      showAlert('–î–æ–¥–∞—Ç–æ–∫ —É—Å–ø—ñ—à–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
      installBtn.style.display = 'none';
    });

    function triggerInstallPrompt() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choiceResult => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
          } else {
            console.log('User dismissed the install prompt');
          }
          deferredPrompt = null;
        });
        if (window.innerWidth <= 768) toggleSidebar();
      } else {
        showAlert('–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ. –°–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞.', true);
      }
    }

    installBtn.onclick = triggerInstallPrompt;

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }

    // Detect offline status
    window.addEventListener('online', () => offlineMessage.style.display = 'none');
    window.addEventListener('offline', () => offlineMessage.style.display = 'block');

    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('active');
    }

    async function setThemePreference(user, theme) {
      if (!user) return;
      await setDoc(doc(db, "preferences", user.uid), { theme }, { merge: true });
    }

    async function getThemePreference(user) {
      if (!user) return "light";
      const prefSnap = await getDoc(doc(db, "preferences", user.uid));
      return prefSnap.exists() && prefSnap.data().theme ? prefSnap.data().theme : "light";
    }

    themeBtn.onclick = async () => {
      document.body.classList.toggle("dark");
      document.querySelectorAll('.modal-content, .article-card, .auth-box, .form-box, .admin-box, .profile-box, .profile-header, .profile-section, .preview-box, .sidebar').forEach(e => e.classList.toggle('dark'));
      document.querySelectorAll('input, textarea, select, .reactions button').forEach(e => e.classList.toggle('dark'));
      document.querySelectorAll('.avatar').forEach(e => e.classList.toggle('dark'));
      const theme = document.body.classList.contains("dark") ? "dark" : "light";
      if (auth.currentUser) await setThemePreference(auth.currentUser, theme);
      if (window.innerWidth <= 768) toggleSidebar();
    };

    function showAlert(message, isError = false) {
      alertMessage.textContent = message;
      alertBox.className = `alert-box ${isError ? 'error' : ''}`;
      alertBox.style.display = 'block';
      setTimeout(() => alertBox.style.display = 'none', 3000);
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = "block";
      document.getElementById(elementId.replace("Error", "")).classList.add("input-error");
    }

    function clearErrors(formType) {
      document.querySelectorAll(`#${formType}Form .error-message`).forEach(e => { e.style.display = "none"; e.textContent = ""; });
      document.querySelectorAll(`#${formType}Form input`).forEach(i => i.classList.remove("input-error"));
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    async function register() {
      if (!navigator.onLine) { showAlert("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      clearErrors("register");
      const nickname = document.getElementById("registerNickname").value.trim();
      const email = document.getElementById("registerEmail").value.trim();
      const password = document.getElementById("registerPassword").value;
      if (!nickname) { showError("registerNicknameError", "–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º"); return; }
      if (!validateEmail(email)) { showError("registerEmailError", "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –ø–æ—à—Ç–∞"); return; }
      if (password.length < 6) { showError("registerPasswordError", "–ü–∞—Ä–æ–ª—å ‚â• 6 —Å–∏–º–≤–æ–ª—ñ–≤"); return; }
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCred.user, { displayName: nickname });
        await setDoc(doc(db, "preferences", userCred.user.uid), { theme: "light" });
        showAlert("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!");
        authBox.style.display = "none";
        if (window.innerWidth <= 768) toggleSidebar();
      } catch (error) {
        showError("registerEmailError", error.code === "auth/email-already-in-use" ? "–ü–æ—à—Ç–∞ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∞" : "–ü–æ–º–∏–ª–∫–∞: " + error.message);
      }
    }

    async function login() {
      if (!navigator.onLine) { showAlert("–í—Ö—ñ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      clearErrors("login");
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!validateEmail(email)) { showError("loginEmailError", "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –ø–æ—à—Ç–∞"); return; }
      if (!password) { showError("loginPasswordError", "–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å"); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showAlert("–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π!");
        authBox.style.display = "none";
        if (window.innerWidth <= 768) toggleSidebar();
      } catch (error) {
        showError("loginEmailError", error.code === "auth/wrong-password" || error.code === "auth/user-not-found" ? "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –ø–æ—à—Ç–∞/–ø–∞—Ä–æ–ª—å" : "–ü–æ–º–∏–ª–∫–∞: " + error.message);
      }
    }

    function toggleAuthForm() {
      registerForm.style.display = registerForm.style.display === "none" ? "block" : "none";
      loginForm.style.display = loginForm.style.display === "none" ? "block" : "none";
      clearErrors("register");
      clearErrors("login");
      if (window.innerWidth <= 768) toggleSidebar();
    }

    async function logout() {
      if (!navigator.onLine) { showAlert("–í–∏—Ö—ñ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      try {
        await signOut(auth);
        showAlert("–í–∏ –≤–∏–π—à–ª–∏ –∑ –∞–∫–∞—É–Ω—Ç–∞");
        articleForm.style.display = "none";
        adminPanel.style.display = "none";
        profileBox.style.display = "none";
        if (window.innerWidth <= 768) toggleSidebar();
      } catch (error) {
        showAlert("–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: " + error.message, true);
      }
    }

    async function updateNickname() {
      if (!navigator.onLine) { showAlert("–û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const nickname = document.getElementById("profileNickname").value.trim();
      const user = auth.currentUser;
      if (!nickname) { showAlert("–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º", true); return; }
      try {
        await updateProfile(user, { displayName: nickname });
        document.getElementById("profileName").textContent = nickname;
        showAlert("–ù—ñ–∫–Ω–µ–π–º –æ–Ω–æ–≤–ª–µ–Ω–æ");
      } catch (error) {
        showAlert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: " + error.message, true);
      }
    }

    async function loadUserProfile(user) {
      if (!user) return;
      document.getElementById("profileNickname").value = user.displayName || "";
      document.getElementById("profileName").textContent = user.displayName || "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á";
      const articlesQuery = query(collection(db, "articles"), where("uid", "==", user.uid));
      const favoritesQuery = query(collection(db, "favorites"), where("uid", "==", user.uid));
      const userArticles = document.getElementById("userArticles");
      const userFavorites = document.getElementById("userFavorites");
      userArticles.innerHTML = "";
      userFavorites.innerHTML = "";
      try {
        const articlesSnap = await getDocs(articlesQuery);
        articlesSnap.forEach(doc => {
          const article = doc.data();
          const div = document.createElement("div");
          div.classList.add("article-card");
          let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
          div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.status}</small>${imgHTML}<p>${article.content.substring(0, 80)}...</p>`;
          div.onclick = () => openModal(doc.id, article);
          userArticles.appendChild(div);
        });
        const favoritesSnap = await getDocs(favoritesQuery);
        for (const favDoc of favoritesSnap.docs) {
          const fav = favDoc.data();
          const articleDoc = await getDoc(doc(db, "articles", fav.articleId));
          if (articleDoc.exists()) {
            const article = articleDoc.data();
            const div = document.createElement("div");
            div.classList.add("article-card");
            let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
            div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.author}</small>${imgHTML}<p>${article.content.substring(0, 80)}...</p>`;
            div.onclick = () => openModal(fav.articleId, article);
            userFavorites.appendChild(div);
          }
        }
      } catch (error) {
        showAlert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é: " + error.message, true);
      }
    }

    function toggleImageInput() {
      document.getElementById("image").style.display = document.getElementById("includeImage").checked ? "block" : "none";
    }

    function previewArticle() {
      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      const image = document.getElementById("includeImage").checked ? document.getElementById("image").value.trim() : "";
      const tags = document.getElementById("tags").value.trim().split(",").map(t => t.trim()).filter(t => t);
      const category = document.getElementById("category").value;
      if (title || content) {
        let imgHTML = image ? `<img class="article-img" src="${image}">` : "";
        previewBox.innerHTML = `
          <h2>${title || "–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥"}</h2>
          <p>${content || "–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç..."}</p>
          ${imgHTML}
          <div>–¢–µ–≥–∏: ${(tags.length ? tags.join(", ") : "–ù–µ–º–∞—î —Ç–µ–≥—ñ–≤")}</div>
          <div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>
        `;
        previewBox.style.display = "block";
      } else {
        showAlert("–í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–±–æ —Ç–µ–∫—Å—Ç", true);
      }
    }

    async function addArticle() {
      if (!navigator.onLine) { showAlert("–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      const image = document.getElementById("includeImage").checked ? document.getElementById("image").value.trim() : "";
      const tags = document.getElementById("tags").value.trim().split(",").map(t => t.trim()).filter(t => t);
      const category = document.getElementById("category").value;
      const user = auth.currentUser;
      if (!user) { showAlert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é", true); return; }
      if (title && content) {
        try {
          await addDoc(collection(db, "articles"), {
            title, content, image, tags, category,
            author: user.displayName || user.email,
            uid: user.uid,
            date: new Date().toLocaleString(),
            likes: 0, dislikes: 0, hearts: 0,
            likedBy: [], dislikedBy: [], heartedBy: [],
            comments: [],
            status: "pending"
          });
          showAlert("–°—Ç–∞—Ç—Ç—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–∞ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É");
          document.getElementById("title").value = "";
          document.getElementById("content").value = "";
          document.getElementById("image").value = "";
          document.getElementById("tags").value = "";
          document.getElementById("includeImage").checked = false;
          toggleImageInput();
          document.getElementById("category").value = "";
          previewBox.style.display = "none";
          if (window.innerWidth <= 768) toggleSidebar();
        } catch (error) {
          showAlert("–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ: " + error.message, true);
        }
      } else {
        showAlert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ —Ç–µ–∫—Å—Ç", true);
      }
    }

    async function editArticle(id) {
      if (!navigator.onLine) { showAlert("–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const articleRef = doc(db, "articles", id);
      const docSnap = await getDoc(articleRef);
      const article = docSnap.data();
      if (article.uid !== auth.currentUser.uid && auth.currentUser.email !== "petro.hryhorenko@gmail.com") return;
      document.getElementById("modalBody").innerHTML = `
        <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—Ç—é</h2>
        <input type="text" id="editTitle" value="${article.title}">
        <textarea id="editContent" rows="5">${article.content}</textarea>
        <input type="text" id="editTags" value="${article.tags.join(', ')}">
        <select id="editCategory" class="dark">
          <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
          <option value="–ù–æ–≤–∏–Ω–∏" ${article.category === "–ù–æ–≤–∏–Ω–∏" ? "selected" : ""}>–ù–æ–≤–∏–Ω–∏</option>
          <option value="–°–ø–æ—Ä—Ç" ${article.category === "–°–ø–æ—Ä—Ç" ? "selected" : ""}>–°–ø–æ—Ä—Ç</option>
          <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó" ${article.category === "–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó" ? "selected" : ""}>–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó</option>
          <option value="–ö—É–ª—å—Ç—É—Ä–∞" ${article.category === "–ö—É–ª—å—Ç—É—Ä–∞" ? "selected" : ""}>–ö—É–ª—å—Ç—É—Ä–∞</option>
        </select>
        <label><input type="checkbox" id="editIncludeImage" ${article.image ? 'checked' : ''} onclick="toggleEditImageInput()"> –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
        <input type="text" id="editImage" value="${article.image}" style="display:${article.image ? 'block' : 'none'};">
        <button class="button" onclick="saveEditedArticle('${id}')">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      `;
    }

    function toggleEditImageInput() {
      document.getElementById("editImage").style.display = document.getElementById("editIncludeImage").checked ? "block" : "none";
    }

    async function saveEditedArticle(id) {
      if (!navigator.onLine) { showAlert("–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const title = document.getElementById("editTitle").value.trim();
      const content = document.getElementById("editContent").value.trim();
      const image = document.getElementById("editIncludeImage").checked ? document.getElementById("editImage").value.trim() : "";
      const tags = document.getElementById("editTags").value.trim().split(",").map(t => t.trim()).filter(t => t);
      const category = document.getElementById("editCategory").value;
      if (title && content) {
        try {
          await updateDoc(doc(db, "articles", id), {
            title, content, image, tags, category,
            status: auth.currentUser.email === "petro.hryhorenko@gmail.com" ? "approved" : "pending"
          });
          closeModal();
          showAlert("–°—Ç–∞—Ç—Ç—é –æ–Ω–æ–≤–ª–µ–Ω–æ");
        } catch (error) {
          showAlert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: " + error.message, true);
        }
      } else {
        showAlert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ —Ç–µ–∫—Å—Ç", true);
      }
    }

    async function deleteArticle(id) {
      if (!navigator.onLine) { showAlert("–í–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é?")) {
        try {
          await deleteDoc(doc(db, "articles", id));
          closeModal();
          showAlert("–°—Ç–∞—Ç—Ç—é –≤–∏–¥–∞–ª–µ–Ω–æ");
        } catch (error) {
          showAlert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: " + error.message, true);
        }
      }
    }

    async function addComment(id) {
      if (!navigator.onLine) { showAlert("–ö–æ–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const commentInput = document.getElementById("commentInput");
      const commentText = commentInput.value.trim();
      const user = auth.currentUser;
      if (!user) { showAlert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏", true); return; }
      if (commentText) {
        try {
          await updateDoc(doc(db, "articles", id), {
            comments: arrayUnion({
              text: commentText,
              author: user.displayName || user.email,
              date: new Date().toLocaleString()
            })
          });
          commentInput.value = "";
          showAlert("–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ–¥–∞–Ω–æ");
        } catch (error) {
          showAlert("–ü–æ–º–∏–ª–∫–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—è: " + error.message, true);
        }
      } else {
        showAlert("–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è", true);
      }
    }

    async function deleteComment(id, comment) {
      if (!navigator.onLine) { showAlert("–í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const user = auth.currentUser;
      if (!user || (comment.author !== (user.displayName || user.email) && user.email !== "petro.hryhorenko@gmail.com")) {
        showAlert("–í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–æ–º–µ–Ω—Ç–∞—Ä", true);
        return;
      }
      try {
        await updateDoc(doc(db, "articles", id), { comments: arrayRemove(comment) });
        showAlert("–ö–æ–º–µ–Ω—Ç–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ");
      } catch (error) {
        showAlert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: " + error.message, true);
      }
    }

    async function toggleFavorite(id) {
      if (!navigator.onLine) { showAlert("–î–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const user = auth.currentUser;
      if (!user) { showAlert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ", true); return; }
      try {
        const favQuery = query(collection(db, "favorites"), where("uid", "==", user.uid), where("articleId", "==", id));
        const favSnap = await getDocs(favQuery);
        if (favSnap.empty) {
          await addDoc(collection(db, "favorites"), { uid: user.uid, articleId: id, date: new Date().toLocaleString() });
          showAlert("–î–æ–¥–∞–Ω–æ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ");
        } else {
          favSnap.forEach(doc => deleteDoc(doc.ref));
          showAlert("–í–∏–¥–∞–ª–µ–Ω–æ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ");
        }
        openModal(id, (await getDoc(doc(db, "articles", id))).data());
      } catch (error) {
        showAlert("–ü–æ–º–∏–ª–∫–∞: " + error.message, true);
      }
    }

    async function renderArticles(snapshot) {
      articlesDiv.innerHTML = "";
      pendingDiv.innerHTML = "";
      const user = auth.currentUser;
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedCategory = categoryFilter.value;

      // Cache articles for offline use
      if (navigator.onLine) {
        const articlesData = [];
        snapshot.forEach(doc => {
          articlesData.push({ id: doc.id, ...doc.data() });
        });
        caches.open('articles-cache').then(cache => {
          cache.put('/articles.json', new Response(JSON.stringify(articlesData)));
        });
      }

      // Render articles
      snapshot.forEach(doc => {
        const article = doc.data();
        const matchesSearch = !searchTerm || article.title.toLowerCase().includes(searchTerm);
        const matchesCategory = !selectedCategory || article.category === selectedCategory;

        if (article.status === "approved" && matchesSearch && matchesCategory) {
          const div = document.createElement("div");
          div.classList.add("article-card");
          let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
          div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.author}</small>${imgHTML}<p>${article.content.substring(0, 80)}...</p><div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${article.category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>`;
          div.onclick = () => openModal(doc.id, article);
          articlesDiv.appendChild(div);
        } else if (user?.email === "petro.hryhorenko@gmail.com" && matchesSearch && matchesCategory) {
          const div = document.createElement("div");
          div.classList.add("article-card");
          let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
          div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.author} | –°—Ç–∞—Ç—É—Å: –û—á—ñ–∫—É—î</small>${imgHTML}<p>${article.content.substring(0, 80)}...</p>`;
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏";
          approveBtn.className = "button";
          approveBtn.onclick = async (e) => {
            e.stopPropagation();
            if (!navigator.onLine) { showAlert("–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
            await updateDoc(doc(db, "articles", doc.id), { status: "approved" });
            showAlert("–°—Ç–∞—Ç—Ç—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞");
          };
          const rejectBtn = document.createElement("button");
          rejectBtn.textContent = "‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏";
          rejectBtn.className = "button secondary";
          rejectBtn.onclick = async (e) => {
            e.stopPropagation();
            if (!navigator.onLine) { showAlert("–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
            if (confirm("–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é?")) {
              await deleteDoc(doc(db, "articles", doc.id));
              showAlert("–°—Ç–∞—Ç—Ç—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–∞");
            }
          };
          div.appendChild(approveBtn);
          div.appendChild(rejectBtn);
          pendingDiv.appendChild(div);
        }
      });

      // Offline fallback rendering
      if (!navigator.onLine) {
        caches.match('/articles.json').then(response => {
          if (response) {
            response.json().then(articlesData => {
              articlesDiv.innerHTML = "";
              articlesData.forEach(article => {
                const matchesSearch = !searchTerm || article.title.toLowerCase().includes(searchTerm);
                const matchesCategory = !selectedCategory || article.category === selectedCategory;
                if (article.status === "approved" && matchesSearch && matchesCategory) {
                  const div = document.createElement("div");
                  div.classList.add("article-card");
                  let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
                  div.innerHTML = `<h3>${article.title}</h3><small>${article.date} | ${article.author}</small>${imgHTML}<p>${article.content.substring(0, 80)}...</p><div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${article.category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>`;
                  div.onclick = () => openModal(article.id, article);
                  articlesDiv.appendChild(div);
                }
              });
            });
          }
        });
      }
    }

    let debounceTimeout;
    function updateArticleList() {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        const q = query(collection(db, "articles"), orderBy("date", "desc"));
        onSnapshot(q, renderArticles, () => {
          if (!navigator.onLine) {
            showAlert("–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true);
            renderArticles([]);
          }
        });
      }, 300);
    }

    searchInput.oninput = updateArticleList;
    categoryFilter.onchange = updateArticleList;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        accountBtn.textContent = "üë§ –ê–∫–∞—É–Ω—Ç";
        accountBtn.onclick = () => {
          profileBox.style.display = profileBox.style.display === "block" ? "none" : "block";
          authBox.style.display = "none";
          articleForm.style.display = "none";
          adminPanel.style.display = "none";
          if (profileBox.style.display === "block") loadUserProfile(user);
          if (window.innerWidth <= 768) toggleSidebar();
        };
        createBtn.style.display = "block";
        createBtn.onclick = () => {
          articleForm.style.display = articleForm.style.display === "block" ? "none" : "block";
          profileBox.style.display = "none";
          adminPanel.style.display = "none";
          authBox.style.display = "none";
          previewBox.style.display = "none";
          if (window.innerWidth <= 768) toggleSidebar();
        };
        adminBtn.style.display = user.email === "petro.hryhorenko@gmail.com" ? "block" : "none";
        adminBtn.onclick = () => {
          adminPanel.style.display = adminPanel.style.display === "block" ? "none" : "block";
          articleForm.style.display = "none";
          profileBox.style.display = "none";
          authBox.style.display = "none";
          if (window.innerWidth <= 768) toggleSidebar();
        };
        const theme = await getThemePreference(user);
        if (theme === "dark") {
          document.body.classList.add("dark");
          document.querySelectorAll('.modal-content, .article-card, .auth-box, .form-box, .admin-box, .profile-box, .profile-header, .profile-section, .preview-box, .sidebar').forEach(e => e.classList.add('dark'));
          document.querySelectorAll('input, textarea, select, .reactions button').forEach(e => e.classList.add('dark'));
          document.querySelectorAll('.avatar').forEach(e => e.classList.add('dark'));
        }
      } else {
        accountBtn.textContent = "üë§ –£–≤—ñ–π—Ç–∏";
        accountBtn.onclick = () => {
          authBox.style.display = authBox.style.display === "block" ? "none" : "block";
          registerForm.style.display = "block";
          loginForm.style.display = "none";
          clearErrors("register");
          clearErrors("login");
          articleForm.style.display = "none";
          adminPanel.style.display = "none";
          profileBox.style.display = "none";
          if (window.innerWidth <= 768) toggleSidebar();
        };
        createBtn.style.display = "none";
        adminBtn.style.display = "none";
      }
      homeBtn.onclick = () => {
        articleForm.style.display = "none";
        adminPanel.style.display = "none";
        profileBox.style.display = "none";
        authBox.style.display = "none";
        if (window.innerWidth <= 768) toggleSidebar();
      };
      updateArticleList();
    });

    async function react(id, type) {
      if (!navigator.onLine) { showAlert("–†–µ–∞–∫—Ü—ñ—ó –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ", true); return; }
      const user = auth.currentUser;
      if (!user) { showAlert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ —Ä–µ–∞–∫—Ü—ñ—é", true); return; }
      const articleRef = doc(db, "articles", id);
      try {
        const docSnap = await getDoc(articleRef);
        const data = docSnap.data();
        const arrs = { likes: "likedBy", dislikes: "dislikedBy", hearts: "heartedBy" };
        const currentArr = arrs[type];
        for (let key in arrs) {
          if (key !== type && data[arrs[key]].includes(user.uid)) {
            await updateDoc(articleRef, { [key]: increment(-1), [arrs[key]]: arrayRemove(user.uid) });
          }
        }
        if (!data[currentArr].includes(user.uid)) {
          await updateDoc(articleRef, { [type]: increment(1), [currentArr]: arrayUnion(user.uid) });
        }
        showAlert("–†–µ–∞–∫—Ü—ñ—è –¥–æ–¥–∞–Ω–∞");
      } catch (error) {
        showAlert("–ü–æ–º–∏–ª–∫–∞ —Ä–µ–∞–∫—Ü—ñ—ó: " + error.message, true);
      }
    }

    async function openModal(id, article) {
      document.getElementById("modal").style.display = "flex";
      let imgHTML = article.image ? `<img class="article-img" src="${article.image}">` : "";
      let editButton = (auth.currentUser && (article.uid === auth.currentUser.uid || auth.currentUser.email === "petro.hryhorenko@gmail.com")) ?
        `<button class="button" onclick="editArticle('${id}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>` : "";
      let deleteButton = (auth.currentUser && (article.uid === auth.currentUser.uid || auth.currentUser.email === "petro.hryhorenko@gmail.com")) ?
        `<button class="button" onclick="deleteArticle('${id}')">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>` : "";
      let favoriteButton = auth.currentUser ? `<button class="button favorite" onclick="toggleFavorite('${id}')">‚≠ê –î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ</button>` : "";
      let commentsHTML = (article.comments || []).map(comment => `
        <div class="comment">
          <div>
            <p>${comment.text}</p>
            <small>${comment.date} | ${comment.author}</small>
          </div>
          ${(auth.currentUser && (comment.author === (auth.currentUser.displayName || auth.currentUser.email) || auth.currentUser.email === "petro.hryhorenko@gmail.com")) ?
            `<button class="delete-comment" onclick='deleteComment("${id}", ${JSON.stringify(comment)})'>üóë</button>` : ""}
        </div>
      `).join('');
      document.getElementById("modalBody").innerHTML = `
        <h2>${article.title}</h2>
        <small>${article.date} | ${article.author}</small>
        ${imgHTML}
        <p>${article.content}</p>
        <div class="reactions">
          <button class="${document.body.classList.contains('dark') ? 'dark' : ''}" onclick="react('${id}','likes')">üëç ${article.likes || 0}</button>
          <button class="${document.body.classList.contains('dark') ? 'dark' : ''}" onclick="react('${id}','dislikes')">üëé ${article.dislikes || 0}</button>
          <button class="${document.body.classList.contains('dark') ? 'dark' : ''}" onclick="react('${id}','hearts')">‚ù§Ô∏è ${article.hearts || 0}</button>
        </div>
        <div>–¢–µ–≥–∏: ${(article.tags || []).join(", ")}</div>
        <div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${article.category || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"}</div>
        ${editButton}
        ${deleteButton}
        ${favoriteButton}
        <div class="comments-section">
          <h3>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h3>
          ${commentsHTML}
          ${auth.currentUser ? `
            <textarea id="commentInput" rows="3" placeholder="–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä" class="${document.body.classList.contains('dark') ? 'dark' : ''}"></textarea>
            <button class="button" onclick="addComment('${id}')">–ö–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏</button>
          ` : '<p>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</p>'}
        </div>
      `;
    }

    function closeModal() { document.getElementById("modal").style.display = "none"; }

    // Expose functions to the global scope
    window.register = register;
    window.login = login;
    window.logout = logout;
    window.addArticle = addArticle;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.react = react;
    window.editArticle = editArticle;
    window.saveEditedArticle = saveEditedArticle;
    window.deleteArticle = deleteArticle;
    window.addComment = addComment;
    window.deleteComment = deleteComment;
    window.toggleImageInput = toggleImageInput;
    window.toggleEditImageInput = toggleEditImageInput;
    window.previewArticle = previewArticle;
    window.toggleSidebar = toggleSidebar;
    window.updateNickname = updateNickname;
    window.toggleFavorite = toggleFavorite;
    window.toggleAuthForm = toggleAuthForm;
    window.triggerInstallPrompt = triggerInstallPrompt;
  </script>
</body>
</html>